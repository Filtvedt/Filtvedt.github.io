var rt=Object.defineProperty;var at=(n,e,t)=>e in n?rt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var v=(n,e,t)=>at(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();function P(){}function Xe(n){return n()}function Se(){return Object.create(null)}function q(n){n.forEach(Xe)}function je(n){return typeof n=="function"}function x(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function lt(n){return Object.keys(n).length===0}function W(n){return n??""}function A(n,e){n.appendChild(e)}function I(n,e,t){n.insertBefore(e,t||null)}function T(n){n.parentNode&&n.parentNode.removeChild(n)}function ee(n,e){for(let t=0;t<n.length;t+=1)n[t]&&n[t].d(e)}function N(n){return document.createElement(n)}function B(n){return document.createTextNode(n)}function H(){return B(" ")}function le(){return B("")}function se(n,e,t,o){return n.addEventListener(e,t,o),()=>n.removeEventListener(e,t,o)}function ct(n){return function(e){return e.stopPropagation(),n.call(this,e)}}function S(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function ht(n){return Array.from(n.childNodes)}function Y(n,e){e=""+e,n.data!==e&&(n.data=e)}function ne(n,e,t,o){t==null?n.style.removeProperty(e):n.style.setProperty(e,t,"")}function M(n,e,t){n.classList.toggle(e,!!t)}function ft(n,e,{bubbles:t=!1,cancelable:o=!1}={}){return new CustomEvent(n,{detail:e,bubbles:t,cancelable:o})}let re;function ie(n){re=n}function ut(){if(!re)throw new Error("Function called outside component initialization");return re}function _e(){const n=ut();return(e,t,{cancelable:o=!1}={})=>{const i=n.$$.callbacks[e];if(i){const r=ft(e,t,{cancelable:o});return i.slice().forEach(s=>{s.call(n,r)}),!r.defaultPrevented}return!0}}const V=[],Ee=[];let X=[];const Ce=[],Ze=Promise.resolve();let ge=!1;function qe(){ge||(ge=!0,Ze.then(et))}function dt(){return qe(),Ze}function me(n){X.push(n)}const de=new Set;let J=0;function et(){if(J!==0)return;const n=re;do{try{for(;J<V.length;){const e=V[J];J++,ie(e),pt(e.$$)}}catch(e){throw V.length=0,J=0,e}for(ie(null),V.length=0,J=0;Ee.length;)Ee.pop()();for(let e=0;e<X.length;e+=1){const t=X[e];de.has(t)||(de.add(t),t())}X.length=0}while(V.length);for(;Ce.length;)Ce.pop()();ge=!1,de.clear(),ie(n)}function pt(n){if(n.fragment!==null){n.update(),q(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(me)}}function gt(n){const e=[],t=[];X.forEach(o=>n.indexOf(o)===-1?e.push(o):t.push(o)),t.forEach(o=>o()),X=e}const ue=new Set;let $;function tt(){$={r:0,c:[],p:$}}function ot(){$.r||q($.c),$=$.p}function O(n,e){n&&n.i&&(ue.delete(n),n.i(e))}function F(n,e,t,o){if(n&&n.o){if(ue.has(n))return;ue.add(n),$.c.push(()=>{ue.delete(n),o&&(t&&n.d(1),o())}),n.o(e)}else o&&o()}function R(n){return(n==null?void 0:n.length)!==void 0?n:Array.from(n)}function ae(n){n&&n.c()}function j(n,e,t){const{fragment:o,after_update:i}=n.$$;o&&o.m(e,t),me(()=>{const r=n.$$.on_mount.map(Xe).filter(je);n.$$.on_destroy?n.$$.on_destroy.push(...r):q(r),n.$$.on_mount=[]}),i.forEach(me)}function Z(n,e){const t=n.$$;t.fragment!==null&&(gt(t.after_update),q(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function mt(n,e){n.$$.dirty[0]===-1&&(V.push(n),qe(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function te(n,e,t,o,i,r,s=null,a=[-1]){const l=re;ie(n);const c=n.$$={fragment:null,ctx:[],props:r,update:P,not_equal:i,bound:Se(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:Se(),dirty:a,skip_bound:!1,root:e.target||l.$$.root};s&&s(c.root);let h=!1;if(c.ctx=t?t(n,e.props||{},(f,d,...g)=>{const k=g.length?g[0]:d;return c.ctx&&i(c.ctx[f],c.ctx[f]=k)&&(!c.skip_bound&&c.bound[f]&&c.bound[f](k),h&&mt(n,f)),d}):[],c.update(),h=!0,q(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const f=ht(e.target);c.fragment&&c.fragment.l(f),f.forEach(T)}else c.fragment&&c.fragment.c();e.intro&&O(n.$$.fragment),j(n,e.target,e.anchor),et()}ie(l)}class oe{constructor(){v(this,"$$");v(this,"$$set")}$destroy(){Z(this,1),this.$destroy=P}$on(e,t){if(!je(t))return P;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(t),()=>{const i=o.indexOf(t);i!==-1&&o.splice(i,1)}}$set(e){this.$$set&&!lt(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const yt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(yt);var p=(n=>(n.PAWN="PAWN",n.KNIGHT="KNIGHT",n.BISHOP="BISHOP",n.ROOK="ROOK",n.QUEEN="QUEEN",n.KING="KING",n))(p||{}),u=(n=>(n.WHITE="WHITE",n.BLACK="BLACK",n))(u||{}),y=(n=>(n.east="east",n.southEast="southEast",n.south="south",n.southWest="southWest",n.west="west",n.northWest="northWest",n.north="north",n.northEast="northEast",n))(y||{}),z=(n=>(n.WHITE_VICTORY="WHITE_VICTORY",n.BLACK_VICTORY="BLACK_VICTORY",n.DRAW="DRAW",n.DRAW_50_MOVE_RULE="DRAW_50_MOVE_RULE",n.DRAW_THREEFOLD_REPETITION="DRAW_THREEFOLD_REPETITION",n))(z||{});const D=8,_=D-1,E=0,fe=4,kt=n=>{if(n===u.BLACK)return"black";if(n===u.WHITE)return"white";throw new Error("Unknown player color!")},Q={east:{x:1,y:0},southEast:{x:1,y:-1},south:{x:0,y:-1},southWest:{x:-1,y:-1},west:{x:-1,y:0},northWest:{x:-1,y:1},north:{x:0,y:1},northEast:{x:1,y:1}},_t=n=>{const e=n.color===u.WHITE?1:-1;return ye(n)*e},ye=n=>{switch(n.type){case p.BISHOP:case p.KNIGHT:return 3;case p.PAWN:return 1;case p.ROOK:return 5;case p.QUEEN:return 9;default:return 0}},Me=1e4,we=-1e4,bt=-1e3,vt=1e3,Te=.6,Ie=.05,Ae=(n,e)=>{if(n.to.piece&&!e.to.piece)return-1;if(!n.to.piece&&e.to.piece)return 1;const t=ye(e.from.piece)-ye(n.from.piece);if(t!=0)return t;const o=n.from.piece.color===u.WHITE?n.from.y:_-n.from.y,r=(e.from.piece.color===u.WHITE?e.from.y:_-e.from.y)-o;if(r!=0)return r;const s=fe-Math.abs(n.from.x-fe);return fe-Math.abs(e.from.x-fe)-s};class be{constructor(e,t,o,i,r,s,a,l){v(this,"board");v(this,"playerTurn");v(this,"castleRights");v(this,"enPassant");v(this,"halfmoveClock");v(this,"fullmoveNumber");v(this,"attacks");v(this,"legalMoves");this.legalMoves=l??[],this.board=e,this.playerTurn=t,this.castleRights=o,this.enPassant=i,this.halfmoveClock=r,this.fullmoveNumber=s,this.attacks=a??{white:[],black:[]},this.attacks=this.getAttacks(),l||this.updateLegalMoves()}getLegalMoves(){return this.legalMoves}updateLegalMoves(){this.legalMoves=this.board.map(e=>e.filter(t=>t.piece!=null&&t.piece.color===this.playerTurn).map(t=>this.getLegalMovesForPiece(t))).flat(2).filter(e=>!this.kingIsInCheck(e))}makeMove(e,t){this.board[e.from.y][e.from.x]={...this.board[e.from.y][e.from.x],piece:null},this.board[e.to.y][e.to.x]={...this.board[e.to.y][e.to.x],piece:e.from.piece},this.playerTurn=this.playerTurn===u.WHITE?u.BLACK:u.WHITE,this.halfmoveClock=e.from.piece.type===p.PAWN||e.to.piece!=null?0:this.halfmoveClock+1,e.from.piece.color===u.BLACK&&this.fullmoveNumber++,this.isCastlingMove(e)&&this.completeCastleMove(e),this.isEnPassantCapture(e)&&this.completeEnPassantCapture(e),e.promotion&&(this.board[e.to.y][e.to.x]={...this.board[e.to.y][e.to.x],piece:{...e.from.piece,type:e.promotion}}),this.updateEnPassantTarget(e),this.updateCastleRights(e),this.updateAttacks(),t||this.updateLegalMoves()}updateEnPassantTarget(e){this.enPassant=e.from.piece.type===p.PAWN&&Math.abs(e.from.y-e.to.y)===2?e.to.notation:null}updateCastleRights(e){const t=e.from.piece.color,o=kt(t);e.from.piece.type===p.KING&&(this.castleRights[o]={queenSide:!1,kingSide:!1}),e.from.piece.type===p.ROOK&&(this.castleRights[o]={queenSide:e.from.x===E?!1:this.castleRights[o].queenSide,kingSide:e.from.x===_?!1:this.castleRights[o].kingSide}),e.to.notation==="a1"&&(this.castleRights.white.queenSide=!1),e.to.notation==="h1"&&(this.castleRights.white.kingSide=!1),e.to.notation==="a8"&&(this.castleRights.black.queenSide=!1),e.to.notation==="h8"&&(this.castleRights.black.kingSide=!1)}completeCastleMove(e){const t=e.to.x;if(t!=2&&t!=6)throw new Error("Invalid castle move, x index is "+t);const o=e.from.piece.color===u.WHITE?E:_,i=t===2?0:7;this.board[o][i]={...this.board[o][i],piece:null};const r=t===2?3:5;this.board[o][r]={...this.board[o][r],piece:{type:p.ROOK,color:e.from.piece.color}}}completeEnPassantCapture(e){const t=e.to.x,o=e.from.y;this.board[o][t]={...this.board[o][t],piece:null}}isPawnPushMove(e){return e.from.piece.type===p.PAWN&&e.from.y!=e.to.y&&e.from.x===e.to.x}isEnPassantCapture(e){return e.from.piece.type===p.PAWN&&e.from.x!=e.to.x&&e.to.piece==null}isCastlingMove(e){var t;return((t=e.from.piece)==null?void 0:t.type)!==p.KING?!1:e.from.piece.color===u.WHITE?e.to.notation==="g1"&&e.from.notation==="e1"||e.to.notation==="c1"&&e.from.notation==="e1":e.to.notation==="g8"&&e.from.notation==="e8"||e.to.notation==="c8"&&e.from.notation==="e8"}getAttacks(){return this.updateAttacks(),this.attacks}updateAttacks(){const e=this.board.map(t=>t.map(o=>{if(o.piece===null)return[];const i=o;return this.getAttacksForPiece(i)})).flat(2);this.attacks.white=e.filter(t=>t.attacker.piece.color===u.WHITE),this.attacks.black=e.filter(t=>t.attacker.piece.color===u.BLACK)}oppesideKingInCheck(){return this.kingInCheck(this.playerTurn===u.WHITE?u.BLACK:u.WHITE)}ownKingInCheck(){return this.kingInCheck(this.playerTurn)}kingInCheck(e){const t=this.findSquare(i=>i.piece!=null&&i.piece.type===p.KING&&i.piece.color===e);return(e===u.WHITE?this.attacks.black:this.attacks.white).some(i=>i.attackTarget.notation===t.notation)}kingIsInCheck(e){const t=this.clone();return t.makeMove(e,!0),t.oppesideKingInCheck()}getAttacksForPiece(e){if(e.piece===null)return[];const t=e;switch(e.piece.type){case p.PAWN:return this.getDirectPawnAttacks(t);case p.KNIGHT:return this.getDirectKnightAttacks(t);case p.BISHOP:return this.getDirectBishopAttacks(t);case p.ROOK:return this.getDirectRookAttacks(t);case p.QUEEN:return this.getDirectQueenAttacks(t);case p.KING:return this.getDirectKingAttacks(t)}}getDirectKingAttacks(e){const t=[y.east,y.west,y.north,y.south,y.northEast,y.northWest,y.southEast,y.southWest],o=s=>!0,i=s=>!0;return t.map(s=>this.getSquaresUntilCondition(e,Q[s],o,i)).flat().map(s=>({attackTarget:s,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectQueenAttacks(e){return this.getDirectBishopAttacks(e).concat(this.getDirectRookAttacks(e))}getDirectRookAttacks(e){const t=s=>!0,o=s=>s.piece!=null;return[y.east,y.west,y.south,y.north].map(s=>this.getSquaresUntilCondition(e,Q[s],t,o)).flat().map(s=>({attackTarget:s,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectBishopAttacks(e){const t=s=>!0,o=s=>s.piece!=null;return[y.northEast,y.northWest,y.southEast,y.southWest].map(s=>this.getSquaresUntilCondition(e,Q[s],t,o)).flat().map(s=>({attackTarget:s,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectKnightAttacks(e){const t=o=>!0;return this.getKnightMoves(e,t).map(o=>({attackTarget:o,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectPawnAttacks(e){let t=[];return e.piece.color===u.WHITE?(e.y+1<=_&&e.x+1<=_&&t.push(this.board[e.y+1][e.x+1]),e.y+1<=_&&e.x-1>=E&&t.push(this.board[e.y+1][e.x-1])):e.piece.color===u.BLACK&&(e.y-1>=E&&e.x+1<=_&&t.push(this.board[e.y-1][e.x+1]),e.y-1>=E&&e.x-1>=E&&t.push(this.board[e.y-1][e.x-1])),t.map(o=>({attackTarget:o,attacker:{piece:e.piece,pieceSquare:e}}))}getLegalMovesForPiece(e){if(e.piece===null)return[];const t=e;switch(e.piece.type){case p.PAWN:return this.getLegalPawnMoves(t);case p.KNIGHT:return this.getLegalKnightMoves(t);case p.BISHOP:return this.getLegalBishopMoves(t);case p.ROOK:return this.getLegalRookMoves(t);case p.QUEEN:return this.getLegalQueenMoves(t);case p.KING:return this.getLegalKingMoves(t)}}getLegalPawnMoves(e){var a,l,c,h;let t=[];e.piece.color===u.WHITE?(e.y+1<=_&&this.board[e.y+1][e.x].piece==null&&t.push(this.board[e.y+1][e.x]),e.y+1<=_&&e.x+1<=_&&(((a=this.board[e.y+1][e.x+1].piece)==null?void 0:a.color)===u.BLACK||this.board[e.y][e.x+1].notation===this.enPassant)&&t.push(this.board[e.y+1][e.x+1]),e.y+1<=_&&e.x-1>=E&&(((l=this.board[e.y+1][e.x-1].piece)==null?void 0:l.color)===u.BLACK||this.board[e.y][e.x-1].notation===this.enPassant)&&t.push(this.board[e.y+1][e.x-1]),e.y===1&&this.board[e.y+1][e.x].piece==null&&this.board[e.y+2][e.x].piece==null&&t.push(this.board[e.y+2][e.x])):e.piece.color===u.BLACK&&(e.y-1>=E&&this.board[e.y-1][e.x].piece==null&&t.push(this.board[e.y-1][e.x]),e.y-1>=E&&e.x+1<=_&&(((c=this.board[e.y-1][e.x+1].piece)==null?void 0:c.color)===u.WHITE||this.board[e.y][e.x+1].notation===this.enPassant)&&t.push(this.board[e.y-1][e.x+1]),e.y-1>=E&&e.x-1>=E&&(((h=this.board[e.y-1][e.x-1].piece)==null?void 0:h.color)===u.WHITE||this.board[e.y][e.x-1].notation===this.enPassant)&&t.push(this.board[e.y-1][e.x-1]),e.y===6&&this.board[e.y-1][e.x].piece==null&&this.board[e.y-2][e.x].piece==null&&t.push(this.board[e.y-2][e.x]));const o=t.filter(f=>e.piece.color===u.WHITE&&f.y===_||e.piece.color===u.BLACK&&f.y===E),i=t.filter(f=>!o.some(d=>d.notation===f.notation)),r=o.map(f=>[p.BISHOP,p.KNIGHT,p.ROOK,p.QUEEN].map(g=>({from:e,to:f,promotion:g}))).flat(2),s=i.map(f=>({from:e,to:f}));return r.concat(s)}getLegalKnightMoves(e){const t=o=>o.piece==null||o.piece.color!=e.piece.color;return this.getKnightMoves(e,t).map(o=>({from:e,to:o}))}getLegalBishopMoves(e){const t=[y.northEast,y.northWest,y.southEast,y.southWest],o=s=>s.piece==null||s.piece.color!=e.piece.color,i=s=>s.piece!=null;return t.map(s=>this.getSquaresUntilCondition(e,Q[s],o,i)).flat().map(s=>({from:e,to:s}))}getLegalRookMoves(e){const t=[y.east,y.west,y.north,y.south],o=s=>s.piece==null||s.piece.color!=e.piece.color,i=s=>s.piece!=null;return t.map(s=>this.getSquaresUntilCondition(e,Q[s],o,i)).flat().map(s=>({from:e,to:s}))}getLegalQueenMoves(e){return this.getLegalBishopMoves(e).concat(this.getLegalRookMoves(e))}canCastleQueenSide(e){return e.piece.color===u.WHITE&&this.castleRights.white.queenSide&&e.notation==="e1"&&this.board[0][1].piece==null&&this.board[0][2].piece==null&&this.board[0][3].piece==null&&!this.kingInCheck(u.WHITE)&&!this.attacks.black.some(t=>t.attackTarget.y===E&&[1,2,3].some(o=>o===t.attackTarget.x))||e.piece.color===u.BLACK&&this.castleRights.black.queenSide&&e.notation==="e8"&&this.board[7][1].piece==null&&this.board[7][2].piece==null&&this.board[7][3].piece==null&&!this.kingInCheck(u.BLACK)&&!this.attacks.white.some(t=>t.attackTarget.y===_&&[1,2,3].some(o=>o===t.attackTarget.x))}canCastleKingSide(e){return e.piece.color===u.WHITE&&this.castleRights.white.kingSide&&e.notation==="e1"&&this.board[0][5].piece==null&&this.board[0][6].piece==null&&!this.kingInCheck(u.WHITE)&&!this.attacks.black.some(t=>t.attackTarget.y===E&&[5,6].some(o=>o===t.attackTarget.x))||e.piece.color===u.BLACK&&this.castleRights.black.kingSide&&e.notation==="e8"&&this.board[7][5].piece==null&&this.board[7][6].piece==null&&!this.kingInCheck(u.BLACK)&&!this.attacks.white.some(t=>t.attackTarget.y===_&&[5,6].some(o=>o===t.attackTarget.x))}getLegalKingMoves(e){const t=[y.east,y.west,y.north,y.south,y.northEast,y.northWest,y.southEast,y.southWest],o=a=>a.piece==null||a.piece.color!=e.piece.color,i=a=>!0,r=t.map(a=>this.getSquaresUntilCondition(e,Q[a],o,i)).flat();let s=[];return this.canCastleKingSide(e)&&s.push(this.board[e.piece.color===u.WHITE?E:_][6]),this.canCastleQueenSide(e)&&s.push(this.board[e.piece.color===u.WHITE?E:_][2]),r.concat(s).map(a=>({from:e,to:a}))}coordinateInsideBoard(e){return e.x>=E&&e.x<=_&&e.y>=E&&e.y<=_}getKnightMoves(e,t){return[{x:e.x+2,y:e.y+1},{x:e.x+2,y:e.y-1},{x:e.x-2,y:e.y+1},{x:e.x-2,y:e.y-1},{x:e.x+1,y:e.y+2},{x:e.x+1,y:e.y-2},{x:e.x-1,y:e.y+2},{x:e.x-1,y:e.y-2}].filter(this.coordinateInsideBoard).map(i=>this.board[i.y][i.x]).filter(t)}getSquaresUntilCondition(e,t,o,i){let r={x:e.x+t.x,y:e.y+t.y},s=[];for(;this.coordinateInsideBoard(r);){const a=this.board[r.y][r.x];if(o(a)&&s.push(a),i(a))break;r.x+=t.x,r.y+=t.y}return s}clone(){return new be(JSON.parse(JSON.stringify(this.board)),JSON.parse(JSON.stringify(this.playerTurn)),JSON.parse(JSON.stringify(this.castleRights)),JSON.parse(JSON.stringify(this.enPassant)),JSON.parse(JSON.stringify(this.halfmoveClock)),JSON.parse(JSON.stringify(this.fullmoveNumber)),JSON.parse(JSON.stringify(this.attacks)),JSON.parse(JSON.stringify(this.legalMoves)))}squareExists(e){return this.findSquares(e).length>0}findSquare(e){const t=this.findSquares(e);if(t.length===0||t.length>1)throw new Error("Find square makes the assumption that the search should return one, and only one result, but number of restults where/was "+JSON.stringify(t));return t[0]}findSquares(e){return this.board.map(t=>t.filter(e)).flat(2)}}class Ne{constructor(e){v(this,"defaultFen","rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");v(this,"fen");v(this,"chessGame");v(this,"gameConfig");v(this,"history");v(this,"result");v(this,"threefoldRepetitionStack");v(this,"log",{game:()=>console.log("Game: ",this.chessGame),board:()=>console.log("Game board: ",this.chessGame.board),fen:()=>console.log("Game as fen: ",this.toFen()),custom:()=>console.log("custom",this.chessGame.board[1][2])});this.fen=e.FEN??this.defaultFen,this.gameConfig=e,this.chessGame=this.toGame(),this.result=null,this.history=[],this.threefoldRepetitionStack=[],this.pushToHistory(),this.checkShouldStopGame(),this.checkAndHandleSinglePlayerMove(),e.gameMode.type==="AiVsAi"&&this.autoPlay(0)}toFen(){return[this.getBoardFen(),this.getPlayerFen(),this.getCastleRightsFen(),this.getEnPassantFen(),this.getHalfmoveClockFen(),this.getFullmoveNumberFen()].reduce((t,o)=>t+(t.length>0?" ":"")+o,"")}toGame(){return new be(this.getBoardFromFen(),this.getPlayerTurnFromFen(),this.getCastleRightsFromFen(),this.getEnPassantFromFen(),this.getHalfmoveClockFromFen(),this.getFullmoveNumberFromFen())}getLegalMoves(){return this.chessGame.getLegalMoves()}makeMove(e){if(this.checkShouldStopGame())return;const t=this.getLegalMoves();if(!t.some(i=>i.from.notation===e.from.notation&&i.to.notation===e.to.notation&&i.promotion==e.promotion)){console.log("Illegal move!",e,t.filter(i=>i.from.piece.type===p.KING));return}this.chessGame.makeMove(e),this.pushToHistory(e),this.updateThreefoldRepetition(),this.checkShouldStopGame()}updateThreefoldRepetition(){let e={board:JSON.parse(JSON.stringify(this.chessGame.board)),legalMoves:this.getLegalMoves()};const t=this.threefoldRepetitionStack.findIndex(o=>{const i=o.position.board.flat().every(s=>this.chessGame.squareExists(a=>{var l,c,h,f;return a.notation===s.notation&&((l=a.piece)==null?void 0:l.color)===((c=s.piece)==null?void 0:c.color)&&((h=a.piece)==null?void 0:h.type)===((f=s.piece)==null?void 0:f.type)})),r=o.position.legalMoves.length===e.legalMoves.length&&o.position.legalMoves.every(s=>e.legalMoves.some(a=>{var l,c,h,f;return a.from.notation===s.from.notation&&a.to.notation===s.to.notation&&a.promotion===s.promotion&&((l=a.from.piece)==null?void 0:l.type)===((c=s.from.piece)==null?void 0:c.type)&&((h=a.from.piece)==null?void 0:h.color)===((f=s.from.piece)==null?void 0:f.color)}));return i&&r});t>=0?this.threefoldRepetitionStack[t].timesReached++:this.threefoldRepetitionStack.push({position:e,timesReached:1})}threefoldRepetitionReached(){return this.threefoldRepetitionStack.filter(e=>e.timesReached>=3).length>0}async checkAndHandleSinglePlayerMove(){if(!this.checkShouldStopGame()&&this.gameConfig.gameMode.type==="SinglePlayerVsAi"&&this.chessGame.playerTurn!==this.gameConfig.gameMode.playerColor&&!this.result){const e=await this.gameConfig.gameMode.algorithmOption.getMove(this.chessGame,this.threefoldRepetitionStack,0,3);this.makePreCheckedMove(e),this.checkShouldStopGame()}}checkShouldStopGame(){return this.updateResult(),this.result!=null}updateResult(){this.getLegalMoves().length===0?this.result=this.chessGame.ownKingInCheck()?this.chessGame.playerTurn===u.WHITE?z.BLACK_VICTORY:z.WHITE_VICTORY:z.DRAW:this.chessGame.halfmoveClock>=50?this.result=z.DRAW_50_MOVE_RULE:this.threefoldRepetitionReached()&&(this.result=z.DRAW_THREEFOLD_REPETITION)}async autoPlay(e){if(!(e>1e3)&&this.gameConfig.gameMode.type=="AiVsAi"&&!this.checkShouldStopGame()){if(this.chessGame.playerTurn===u.WHITE){const t=await this.gameConfig.gameMode.algorithmOptions.white.getMove(this.chessGame,this.threefoldRepetitionStack,0,0);this.makePreCheckedMove(t)}else{const t=await this.gameConfig.gameMode.algorithmOptions.black.getMove(this.chessGame,this.threefoldRepetitionStack,0,0);this.makePreCheckedMove(t)}e+=1,this.autoPlay(e)}}makePreCheckedMove(e){this.chessGame.makeMove(e),this.pushToHistory(e),this.updateThreefoldRepetition()}pushToHistory(e){this.history.push({game:this.chessGame.clone(),move:e??null})}getBoardFromFen(){let e=Array.from({length:D},(s,a)=>Array.from({length:D},(l,c)=>({x:c,y:a,piece:null,notation:this.getNotation(c,a)})));const o=this.fen.split(" ")[0].split("/"),i=s=>{switch(s.toLowerCase()){case"p":return p.PAWN;case"r":return p.ROOK;case"n":return p.KNIGHT;case"b":return p.BISHOP;case"q":return p.QUEEN;case"k":return p.KING;default:throw new Error("Fen char <"+s+"> is not a valid pieceType!")}},r=(s,a,l,c,h)=>{if(a>D)throw new Error("Out of bound in fen board parsing.");if(a>_)return;const f=s.charAt(h);if(isNaN(Number(f)))return l[_-c][a].piece={color:f==f.toUpperCase()?u.WHITE:u.BLACK,type:i(f)},a++,h++,r(s,a,l,c,h);const d=Number(f);return a+=d,h++,r(s,a,l,c,h)};return o.forEach((s,a)=>r(s,0,e,a,0)),e}getPlayerTurnFromFen(){return this.fen.split(" ")[1]==="w"?u.WHITE:u.BLACK}getCastleRightsFromFen(){const e=this.fen.split(" ")[2];return{white:{queenSide:e.includes("Q"),kingSide:e.includes("K")},black:{queenSide:e.includes("q"),kingSide:e.includes("k")}}}getEnPassantFromFen(){const e=this.fen.split(" ")[3];return e==="-"?null:e}getHalfmoveClockFromFen(){return Number(this.fen.split(" ")[4])}getFullmoveNumberFromFen(){return Number(this.fen.split(" ")[5])}getBoardFen(){const e=o=>{let i;switch(o.type){case p.PAWN:i="p";break;case p.KNIGHT:i="n";break;case p.BISHOP:i="b";break;case p.ROOK:i="r";break;case p.QUEEN:i="q";break;case p.KING:i="k";break;default:throw new Error("Invalid pieceType found in conversion to fen!")}return o.color===u.WHITE?i.toUpperCase():i},t=(o,i,r)=>{if(o>D)throw new Error("Index out of bounds while converting board to fen!");if(o>_)return r>0?r+"":"";const s=i[o];return o++,s.piece?(r>0?r+"":"")+e(s.piece)+t(o,i,0):(r++,t(o,i,r))};return[...this.chessGame.board].reverse().map(o=>t(0,o,0)).reduce((o,i)=>o+(o.length>0?"/":"")+i,"")}getPlayerFen(){return this.chessGame.playerTurn===u.WHITE?"w":"b"}getCastleRightsFen(){const e=this.chessGame.castleRights;if(!(e.black.kingSide||e.black.queenSide||e.white.kingSide||e.white.queenSide))return"-";let t="";return t+=e.white.kingSide?"K":"",t+=e.white.queenSide?"Q":"",t+=e.black.kingSide?"k":"",t+=e.black.queenSide?"q":"",t}getEnPassantFen(){return this.chessGame.enPassant==null?"-":this.chessGame.enPassant}getHalfmoveClockFen(){return this.chessGame.halfmoveClock+""}getFullmoveNumberFen(){return this.chessGame.fullmoveNumber+""}getNotation(e,t){let o="";switch(e){case 0:o="a";break;case 1:o="b";break;case 2:o="c";break;case 3:o="d";break;case 4:o="e";break;case 5:o="f";break;case 6:o="g";break;case 7:o="h";break;default:throw new Error("Notation x index out of bound: "+e)}if(t<E||t>_)throw new Error("Notation y index out of bound: "+t);return o+=t+1,o}}function Pe(n,e,t){const o=n.slice();return o[4]=e[t],o[6]=t,o}function Re(n,e,t){const o=n.slice();return o[7]=e[t],o[9]=t,o}function Le(n){let e,t=n[1]===u.WHITE&&n[7].notation.includes("a")||n[1]===u.BLACK&&n[7].notation.includes("h"),o,i=n[1]===u.WHITE&&n[7].notation.includes("1")||n[1]===u.BLACK&&n[7].notation.includes("8"),r,s,a=t&&Ke(n),l=i&&Oe(n);return{c(){e=N("div"),a&&a.c(),o=H(),l&&l.c(),r=H(),S(e,"class",s=W("notation "+n[7].notation)+" svelte-1lhqun1"),M(e,"reverse-color",(n[9]+n[6]%2)%2===0),M(e,"reverse",n[1]===u.BLACK)},m(c,h){I(c,e,h),a&&a.m(e,null),A(e,o),l&&l.m(e,null),A(e,r)},p(c,h){h&3&&(t=c[1]===u.WHITE&&c[7].notation.includes("a")||c[1]===u.BLACK&&c[7].notation.includes("h")),t?a?a.p(c,h):(a=Ke(c),a.c(),a.m(e,o)):a&&(a.d(1),a=null),h&3&&(i=c[1]===u.WHITE&&c[7].notation.includes("1")||c[1]===u.BLACK&&c[7].notation.includes("8")),i?l?l.p(c,h):(l=Oe(c),l.c(),l.m(e,r)):l&&(l.d(1),l=null),h&1&&s!==(s=W("notation "+c[7].notation)+" svelte-1lhqun1")&&S(e,"class",s),h&1&&M(e,"reverse-color",(c[9]+c[6]%2)%2===0),h&3&&M(e,"reverse",c[1]===u.BLACK)},d(c){c&&T(e),a&&a.d(),l&&l.d()}}}function Ke(n){let e,t=n[7].notation.charAt(1)+"",o;return{c(){e=N("div"),o=B(t),S(e,"class","top svelte-1lhqun1")},m(i,r){I(i,e,r),A(e,o)},p(i,r){r&1&&t!==(t=i[7].notation.charAt(1)+"")&&Y(o,t)},d(i){i&&T(e)}}}function Oe(n){let e,t=n[7].notation.charAt(0)+"",o;return{c(){e=N("div"),o=B(t),S(e,"class","bottom svelte-1lhqun1")},m(i,r){I(i,e,r),A(e,o)},p(i,r){r&1&&t!==(t=i[7].notation.charAt(0)+"")&&Y(o,t)},d(i){i&&T(e)}}}function He(n){let e=n[1]===u.BLACK&&n[2].includes(n[7].notation)||n[1]===u.WHITE&&n[3].includes(n[7].notation),t,o=e&&Le(n);return{c(){o&&o.c(),t=le()},m(i,r){o&&o.m(i,r),I(i,t,r)},p(i,r){r&3&&(e=i[1]===u.BLACK&&i[2].includes(i[7].notation)||i[1]===u.WHITE&&i[3].includes(i[7].notation)),e?o?o.p(i,r):(o=Le(i),o.c(),o.m(t.parentNode,t)):o&&(o.d(1),o=null)},d(i){i&&T(t),o&&o.d(i)}}}function We(n){let e,t=R(n[4]),o=[];for(let i=0;i<t.length;i+=1)o[i]=He(Re(n,t,i));return{c(){for(let i=0;i<o.length;i+=1)o[i].c();e=le()},m(i,r){for(let s=0;s<o.length;s+=1)o[s]&&o[s].m(i,r);I(i,e,r)},p(i,r){if(r&15){t=R(i[4]);let s;for(s=0;s<t.length;s+=1){const a=Re(i,t,s);o[s]?o[s].p(a,r):(o[s]=He(a),o[s].c(),o[s].m(e.parentNode,e))}for(;s<o.length;s+=1)o[s].d(1);o.length=t.length}},d(i){i&&T(e),ee(o,i)}}}function St(n){let e,t=R(n[0]),o=[];for(let i=0;i<t.length;i+=1)o[i]=We(Pe(n,t,i));return{c(){for(let i=0;i<o.length;i+=1)o[i].c();e=le()},m(i,r){for(let s=0;s<o.length;s+=1)o[s]&&o[s].m(i,r);I(i,e,r)},p(i,[r]){if(r&15){t=R(i[0]);let s;for(s=0;s<t.length;s+=1){const a=Pe(i,t,s);o[s]?o[s].p(a,r):(o[s]=We(a),o[s].c(),o[s].m(e.parentNode,e))}for(;s<o.length;s+=1)o[s].d(1);o.length=t.length}},i:P,o:P,d(i){i&&T(e),ee(o,i)}}}function Et(n,e,t){let{board:o}=e,{playerColor:i}=e,r=["h8","h7","h6","h5","h4","h3","h2","h1","g8","f8","e8","d8","c8","b8","a8"],s=["a8","a7","a6","a5","a4","a3","a2","h1","g1","f1","e1","d1","c1","b1","a1"];return n.$$set=a=>{"board"in a&&t(0,o=a.board),"playerColor"in a&&t(1,i=a.playerColor)},[o,i,r,s]}class Ct extends oe{constructor(e){super(),te(this,e,Et,St,x,{board:0,playerColor:1})}}function Ge(n,e,t){const o=n.slice();return o[5]=e[t],o}function Be(n){let e,t,o,i;function r(){return n[3](n[5])}return{c(){e=N("button"),S(e,"class",t=W("selection "+n[0].from.piece.color.toLowerCase()+" "+n[5])+" svelte-rshfpz")},m(s,a){I(s,e,a),o||(i=se(e,"click",r),o=!0)},p(s,a){n=s,a&1&&t!==(t=W("selection "+n[0].from.piece.color.toLowerCase()+" "+n[5])+" svelte-rshfpz")&&S(e,"class",t)},d(s){s&&T(e),o=!1,i()}}}function Mt(n){let e,t,o,i=R(n[2]),r=[];for(let s=0;s<i.length;s+=1)r[s]=Be(Ge(n,i,s));return{c(){e=N("div"),t=N("div");for(let s=0;s<r.length;s+=1)r[s].c();S(t,"class","selections svelte-rshfpz"),S(e,"class",o=W("promotionSelect "+n[0].to.notation)+" svelte-rshfpz"),M(e,"reverse",n[0].from.piece.color===u.BLACK)},m(s,a){I(s,e,a),A(e,t);for(let l=0;l<r.length;l+=1)r[l]&&r[l].m(t,null)},p(s,[a]){if(a&7){i=R(s[2]);let l;for(l=0;l<i.length;l+=1){const c=Ge(s,i,l);r[l]?r[l].p(c,a):(r[l]=Be(c),r[l].c(),r[l].m(t,null))}for(;l<r.length;l+=1)r[l].d(1);r.length=i.length}a&1&&o!==(o=W("promotionSelect "+s[0].to.notation)+" svelte-rshfpz")&&S(e,"class",o),a&1&&M(e,"reverse",s[0].from.piece.color===u.BLACK)},i:P,o:P,d(s){s&&T(e),ee(r,s)}}}function wt(n,e,t){let{move:o}=e;const i=_e();function r(l){i("promotionSelected",{...o,promotion:l})}const s=[p.BISHOP,p.KNIGHT,p.ROOK,p.QUEEN],a=l=>r(l);return n.$$set=l=>{"move"in l&&t(0,o=l.move)},[o,r,s,a]}class Tt extends oe{constructor(e){super(),te(this,e,wt,Mt,x,{move:0})}}function Fe(n,e,t){const o=n.slice();return o[18]=e[t],o}function $e(n,e,t){const o=n.slice();return o[21]=e[t],o}function De(n){let e,t;return e=new Tt({props:{move:n[6]}}),e.$on("promotionSelected",n[10]),{c(){ae(e.$$.fragment)},m(o,i){j(e,o,i),t=!0},p(o,i){const r={};i&64&&(r.move=o[6]),e.$set(r)},i(o){t||(O(e.$$.fragment,o),t=!0)},o(o){F(e.$$.fragment,o),t=!1},d(o){Z(e,o)}}}function xe(n){let e,t,o,i,r,s;function a(...l){return n[11](n[21],...l)}return{c(){var l,c,h,f;e=N("div"),S(e,"id",t=n[21].notation),S(e,"class",o=W("square "+n[21].notation+" "+(((l=n[21].piece)==null?void 0:l.type)??""))+" svelte-10v6ywf"),S(e,"role","presentation"),S(e,"style",i=n[3]===n[21].notation?`transform: translate(${n[4]}%,${n[5]}%);`:""),M(e,"hide-piece",((c=n[6])==null?void 0:c.from.notation)===n[21].notation),M(e,"attacked",n[1].attacks.white.some(a)),M(e,"reverse",n[2]===u.BLACK),M(e,"piece",n[21].piece!=null),M(e,"white",((h=n[21].piece)==null?void 0:h.color)===u.WHITE),M(e,"black",((f=n[21].piece)==null?void 0:f.color)===u.BLACK),M(e,"dragging",n[3]===n[21].notation)},m(l,c){I(l,e,c),r||(s=se(e,"mousedown",n[7]),r=!0)},p(l,c){var h,f,d,g;n=l,c&2&&t!==(t=n[21].notation)&&S(e,"id",t),c&2&&o!==(o=W("square "+n[21].notation+" "+(((h=n[21].piece)==null?void 0:h.type)??""))+" svelte-10v6ywf")&&S(e,"class",o),c&58&&i!==(i=n[3]===n[21].notation?`transform: translate(${n[4]}%,${n[5]}%);`:"")&&S(e,"style",i),c&66&&M(e,"hide-piece",((f=n[6])==null?void 0:f.from.notation)===n[21].notation),c&2&&M(e,"attacked",n[1].attacks.white.some(a)),c&6&&M(e,"reverse",n[2]===u.BLACK),c&2&&M(e,"piece",n[21].piece!=null),c&2&&M(e,"white",((d=n[21].piece)==null?void 0:d.color)===u.WHITE),c&2&&M(e,"black",((g=n[21].piece)==null?void 0:g.color)===u.BLACK),c&10&&M(e,"dragging",n[3]===n[21].notation)},d(l){l&&T(e),r=!1,s()}}}function Ue(n){let e,t=R(n[18]),o=[];for(let i=0;i<t.length;i+=1)o[i]=xe($e(n,t,i));return{c(){for(let i=0;i<o.length;i+=1)o[i].c();e=le()},m(i,r){for(let s=0;s<o.length;s+=1)o[s]&&o[s].m(i,r);I(i,e,r)},p(i,r){if(r&254){t=R(i[18]);let s;for(s=0;s<t.length;s+=1){const a=$e(i,t,s);o[s]?o[s].p(a,r):(o[s]=xe(a),o[s].c(),o[s].m(e.parentNode,e))}for(;s<o.length;s+=1)o[s].d(1);o.length=t.length}},d(i){i&&T(e),ee(o,i)}}}function It(n){let e,t,o,i,r,s,a,l;o=new Ct({props:{board:n[1].board,playerColor:n[2]}});let c=n[6]&&De(n),h=R(n[1].board),f=[];for(let d=0;d<h.length;d+=1)f[d]=Ue(Fe(n,h,d));return{c(){e=N("div"),t=N("div"),ae(o.$$.fragment),i=H(),c&&c.c(),r=H();for(let d=0;d<f.length;d+=1)f[d].c();S(t,"id","board-background"),S(t,"class","board svelte-10v6ywf"),ne(t,"width",n[0]+"px"),ne(t,"height",n[0]+"px"),S(e,"class","chess-board-layout svelte-10v6ywf")},m(d,g){I(d,e,g),A(e,t),j(o,t,null),A(t,i),c&&c.m(t,null),A(t,r);for(let k=0;k<f.length;k+=1)f[k]&&f[k].m(t,null);s=!0,a||(l=[se(window,"mouseup",n[9]),se(window,"mousemove",n[8])],a=!0)},p(d,[g]){const k={};if(g&2&&(k.board=d[1].board),g&4&&(k.playerColor=d[2]),o.$set(k),d[6]?c?(c.p(d,g),g&64&&O(c,1)):(c=De(d),c.c(),O(c,1),c.m(t,r)):c&&(tt(),F(c,1,1,()=>{c=null}),ot()),g&254){h=R(d[1].board);let b;for(b=0;b<h.length;b+=1){const w=Fe(d,h,b);f[b]?f[b].p(w,g):(f[b]=Ue(w),f[b].c(),f[b].m(t,null))}for(;b<f.length;b+=1)f[b].d(1);f.length=h.length}(!s||g&1)&&ne(t,"width",d[0]+"px"),(!s||g&1)&&ne(t,"height",d[0]+"px")},i(d){s||(O(o.$$.fragment,d),O(c),s=!0)},o(d){F(o.$$.fragment,d),F(c),s=!1},d(d){d&&T(e),Z(o),c&&c.d(),ee(f,d),a=!1,q(l)}}}function At(n,e,t){let{boardSize:o}=e,{chessGame:i}=e,{playerColor:r}=e,s,a,l,c=null;const h=_e(),f=m=>{let C=m.target;d(C,m)},d=(m,C)=>{var ve;const L=(ve=m.parentElement)==null?void 0:ve.getBoundingClientRect();if(!L)return;t(3,s=m.id);const K=L.width/D,U=L.height/D,it=C.clientX-(L.left+K/2),st=C.clientY-(L.top+U/2);t(4,a=Math.floor(it*100/K)),t(5,l=Math.floor(st*100/U))};function g(m){if(s){let C=m.target;d(C,m)}}const k=()=>{if(s){const m=i.findSquare(U=>U.notation===s);if(!m.piece){t(3,s=null);return}const C=m,L=he(a,l,r),K=i.board[L.y][L.x];if(ce(C,K)){G(C,K);return}w({from:C,to:K})}t(3,s=null)},b=m=>{t(6,c=null),w(m.detail)},w=m=>{h("manualMoveMade",{...m})},G=(m,C)=>{t(6,c={from:m,to:C})},ce=(m,C)=>!i.getLegalMoves().some(K=>K.from.notation===m.notation&&K.to.notation===C.notation)||m.piece.type!==p.PAWN?!1:m.piece.color===u.WHITE&&C.y===_||m.piece.color===u.BLACK&&C.y===E,he=(m,C,L)=>{L===u.BLACK?m=Math.abs(700-m):C=Math.abs(700-C);const K=Math.max(E,Math.min(_,Math.round(m/100))),U=Math.max(E,Math.min(_,Math.round(C/100)));return{x:K,y:U}},nt=(m,C)=>C.attackTarget.notation===m.notation;return n.$$set=m=>{"boardSize"in m&&t(0,o=m.boardSize),"chessGame"in m&&t(1,i=m.chessGame),"playerColor"in m&&t(2,r=m.playerColor)},[o,i,r,s,a,l,c,f,g,k,b,nt]}class Nt extends oe{constructor(e){super(),te(this,e,At,It,x,{boardSize:0,chessGame:1,playerColor:2})}}function Je(n,e,t){const o=n.slice();return o[7]=e[t],o[9]=t,o}function Pt(n){let e,t,o,i=n[7].move.from.notation+" -> "+n[7].move.to.notation,r;return{c(){e=N("div"),o=H(),r=B(i),S(e,"class",t=W(n[7].move.from.piece.type+" history-logo "+n[7].move.from.piece.color.toLowerCase())+" svelte-wp4h0a")},m(s,a){I(s,e,a),I(s,o,a),I(s,r,a)},p(s,a){a&1&&t!==(t=W(s[7].move.from.piece.type+" history-logo "+s[7].move.from.piece.color.toLowerCase())+" svelte-wp4h0a")&&S(e,"class",t),a&1&&i!==(i=s[7].move.from.notation+" -> "+s[7].move.to.notation)&&Y(r,i)},d(s){s&&(T(e),T(o),T(r))}}}function Rt(n){let e="Start position",t;return{c(){t=B(e)},m(o,i){I(o,t,i)},p:P,d(o){o&&T(t)}}}function Qe(n){let e,t;function o(s,a){return s[7].move?Pt:Rt}let i=o(n),r=i(n);return{c(){e=N("li"),r.c(),t=H(),S(e,"class","history-entry svelte-wp4h0a"),M(e,"currentHistory",n[9]===n[1])},m(s,a){I(s,e,a),r.m(e,null),A(e,t)},p(s,a){i===(i=o(s))&&r?r.p(s,a):(r.d(1),r=i(s),r&&(r.c(),r.m(e,t))),a&2&&M(e,"currentHistory",s[9]===s[1])},d(s){s&&T(e),r.d()}}}function Lt(n){let e,t,o,i,r,s=R(n[0].history),a=[];for(let l=0;l<s.length;l+=1)a[l]=Qe(Je(n,s,l));return{c(){e=N("div"),t=N("div"),o=N("ol");for(let l=0;l<a.length;l+=1)a[l].c();S(o,"class","svelte-wp4h0a"),S(e,"class","box svelte-wp4h0a")},m(l,c){I(l,e,c),A(e,t),A(t,o);for(let h=0;h<a.length;h+=1)a[h]&&a[h].m(o,null);i||(r=se(window,"keydown",ct(n[2])),i=!0)},p(l,[c]){if(c&3){s=R(l[0].history);let h;for(h=0;h<s.length;h+=1){const f=Je(l,s,h);a[h]?a[h].p(f,c):(a[h]=Qe(f),a[h].c(),a[h].m(o,null))}for(;h<a.length;h+=1)a[h].d(1);a.length=s.length}},i:P,o:P,d(l){l&&T(e),ee(a,l),i=!1,r()}}}function Kt(n,e,t){let{gameManager:o}=e,i=null;const r=_e(),s=()=>{r("historySelected",a())},a=()=>i==null?o.chessGame:i<o.history.length?o.history[i].game:o.chessGame,l=h=>{o.result&&(i==null?t(1,i=o.history.length-1):h===1?t(1,i=i<o.history.length-1?i+1:i):h===-1&&t(1,i=i>0?i-1:i),s())},c=h=>{switch(h.key){case"ArrowRight":case"ArrowDown":l(1);break;case"ArrowLeft":case"ArrowUp":l(-1);break}};return n.$$set=h=>{"gameManager"in h&&t(0,o=h.gameManager)},[o,i,c]}class Ot extends oe{constructor(e){super(),te(this,e,Kt,Lt,x,{gameManager:0})}}function Ve(n){let e,t="Player turn = "+n[0].chessGame.playerTurn,o,i,r="Result = "+n[0].result,s,a,l="Moves = "+n[0].chessGame.fullmoveNumber,c,h,f,d,g,k,b;return d=new Nt({props:{chessGame:n[1],playerColor:n[2],boardSize:ze}}),d.$on("manualMoveMade",n[3]),k=new Ot({props:{gameManager:n[0]}}),k.$on("historySelected",n[4]),{c(){e=N("div"),o=B(t),i=H(),s=B(r),a=H(),c=B(l),h=H(),f=N("div"),ae(d.$$.fragment),g=H(),ae(k.$$.fragment),S(f,"class","board-controls svelte-vw9cvi"),ne(f,"height",ze+"px")},m(w,G){I(w,e,G),A(e,o),A(e,i),A(e,s),A(e,a),A(e,c),A(e,h),A(e,f),j(d,f,null),A(f,g),j(k,f,null),b=!0},p(w,G){(!b||G&1)&&t!==(t="Player turn = "+w[0].chessGame.playerTurn)&&Y(o,t),(!b||G&1)&&r!==(r="Result = "+w[0].result)&&Y(s,r),(!b||G&1)&&l!==(l="Moves = "+w[0].chessGame.fullmoveNumber)&&Y(c,l);const ce={};G&2&&(ce.chessGame=w[1]),d.$set(ce);const he={};G&1&&(he.gameManager=w[0]),k.$set(he)},i(w){b||(O(d.$$.fragment,w),O(k.$$.fragment,w),b=!0)},o(w){F(d.$$.fragment,w),F(k.$$.fragment,w),b=!1},d(w){w&&T(e),Z(d),Z(k)}}}function Ht(n){let e=n[0].chessGame.playerTurn,t,o,i=Ve(n);return{c(){i.c(),t=le()},m(r,s){i.m(r,s),I(r,t,s),o=!0},p(r,[s]){s&1&&x(e,e=r[0].chessGame.playerTurn)?(tt(),F(i,1,1,P),ot(),i=Ve(r),i.c(),O(i,1),i.m(t.parentNode,t)):i.p(r,s)},i(r){o||(O(i),o=!0)},o(r){F(i),o=!1},d(r){r&&T(t),i.d(r)}}}let ze=800;function Wt(n,e,t){let{gameManager:o}=e,i=o.gameConfig.gameMode.playerColor,r=o.chessGame;const s=async f=>{o.makeMove(f),await a()},a=async()=>{t(1,r=o.chessGame),t(0,o),await dt()},l=f=>{c(f)},c=async f=>{const d=f.detail;o.gameConfig.gameMode.type!=="AiVsAi"&&r.playerTurn==d.from.piece.color&&(await s(d),o.checkAndHandleSinglePlayerMove().then(g=>a()))},h=f=>{t(1,r=f.detail)};return n.$$set=f=>{"gameManager"in f&&t(0,o=f.gameManager)},[o,r,i,l,h]}class Gt extends oe{constructor(e){super(),te(this,e,Wt,Ht,x,{gameManager:0})}}class Ye{constructor(e){v(this,"boardScorer");this.boardScorer=e}async getMove(e,t,o,i){const r=e.getLegalMoves();if(r.length===0)throw new Error("No legal moves present - the game should have ended!");const s=Math.floor(Math.random()*(r.length-1));return r[s]}}class pe{getScore(e,t,o){return 0}}class Bt{constructor(e){v(this,"boardScorer");this.boardScorer=e}async getMove(e,t,o,i){const r=e.getLegalMoves();if(r.length===0)throw new Error("No legal moves present - the game should have ended!");return r[0]}}const{port1:Ft,port2:ke}=new MessageChannel;ke.start();function $t(){return new Promise(n=>{const e=Math.random();ke.addEventListener("message",function t(o){o.data===e&&(ke.removeEventListener("message",t),n())}),Ft.postMessage(e)})}class Dt{constructor(e){v(this,"boardScorer");v(this,"skips",{});v(this,"evaluatedPositions",0);this.boardScorer=e,this.evaluatedPositions=0}async getMove(e,t,o,i){this.evaluatedPositions=0;let r=we,s=Me;const a={chessGame:e.clone(),threefoldRepetitionStack:JSON.parse(JSON.stringify(t))},l=await this.minMax(a,i,r,s,a.chessGame.playerTurn!=e.playerTurn,i);return console.log("Evaluation complete! Alpha-Beta Pruning :",this.skips," Best found move:",l.move,"Total evaluated moves:"+this.evaluatedPositions),l.move}async minMax(e,t,o,i,r,s){if(await $t(),t===0||e.chessGame.getLegalMoves().length===0)return this.evaluatedPositions++,this.evalGame(e,t===0?t+1:t);if(r){let a=we,l=null;for(let[c,h]of e.chessGame.getLegalMoves().sort(Ae).entries()){const f=this.asNode(e,h),g=await this.minMax(f,t-1,o,i,!1,s),k=g.score??g;if(k>a?l=h:k==a&&(l=Math.floor(Math.random()*2)?l:h),a=Math.max(a,k),o=Math.max(o,a),i<=o){const b=e.chessGame.getLegalMoves().length-(c+1);this.addSkips(t-1,b);break}}return{score:a,move:l}}else{let a=Me,l=null;for(let[c,h]of e.chessGame.getLegalMoves().sort(Ae).entries()){const f=this.asNode(e,h),g=await this.minMax(f,t-1,o,i,!0,s),k=g.score??g;if(k<a?l=h:k==a&&(l=Math.floor(Math.random()*2)?l:h),a=Math.min(a,k),i=Math.min(i,k),i<=o){const b=e.chessGame.getLegalMoves().length-(c+1);this.addSkips(t-1,b);break}}return{score:a,move:l}}}addSkips(e,t){if(!this.skips[e]){this.skips[e]=t;return}this.skips[e]+=t}evalGame(e,t){return this.boardScorer.getScore(e.chessGame,e.threefoldRepetitionStack,t)}asNode(e,t){const o=e.chessGame.clone();let i=JSON.parse(JSON.stringify(e.threefoldRepetitionStack));return o.makeMove(t),i=this.updateThreefoldRepetition(o,i),{chessGame:o,threefoldRepetitionStack:i}}moveToString(e){return e?"("+e.from.piece.type+") "+e.from.notation+" -> "+e.to.notation:""}updateThreefoldRepetition(e,t){let o={board:e.board,legalMoves:e.getLegalMoves()};const i=t.findIndex(r=>{const s=r.position.board.flat().every(l=>e.squareExists(c=>{var h,f,d,g;return c.notation===l.notation&&((h=c.piece)==null?void 0:h.color)===((f=l.piece)==null?void 0:f.color)&&((d=c.piece)==null?void 0:d.type)===((g=l.piece)==null?void 0:g.type)})),a=r.position.legalMoves.length===o.legalMoves.length&&r.position.legalMoves.every(l=>o.legalMoves.some(c=>{var h,f,d,g;return c.from.notation===l.from.notation&&c.to.notation===l.to.notation&&c.promotion===l.promotion&&((h=c.from.piece)==null?void 0:h.type)===((f=l.from.piece)==null?void 0:f.type)&&((d=c.from.piece)==null?void 0:d.color)===((g=l.from.piece)==null?void 0:g.color)}));return s&&a});return i>=0?t[i].timesReached++:t.push({position:o,timesReached:1}),t}}class xt{constructor(){v(this,"getChainScore",(e,t)=>[{color:u.WHITE,x:e.x+1,y:e.y+1},{color:u.WHITE,x:e.x-1,y:e.y+1},{color:u.BLACK,x:e.x-1,y:e.y-1},{color:u.BLACK,x:e.x+1,y:e.y-1}].filter(i=>{var r,s;return e.piece.color===i.color&&this.coordinateInsideBoard({...i})&&((r=t[i.y][i.x].piece)==null?void 0:r.color)===e.piece.color&&((s=t[i.y][i.x].piece)==null?void 0:s.type)===p.PAWN}).map(i=>e.piece.color===u.WHITE?Te:Te*-1))}getScore(e,t,o){if(e.getLegalMoves().length===0)return e.kingInCheck(u.WHITE)?bt-o:e.kingInCheck(u.BLACK)?vt+o:0;if(t.some(l=>l.timesReached>=3))return 0;const i=e.board.flat(),r=i.map(l=>l.piece?_t(l.piece):0).reduce((l,c)=>l+c,0),s=i.map(l=>l.piece&&l.piece.type===p.PAWN?this.getChainScore(l,e.board):0).flat().reduce((l,c)=>l+c,0),a=i.filter(l=>{var c;return((c=l.piece)==null?void 0:c.type)===p.PAWN}).map(l=>{var c;return((c=l.piece)==null?void 0:c.color)===u.WHITE?(l.y-2)*Ie:(_-(l.y+2))*Ie}).reduce((l,c)=>l+c,0);return r+s+a}coordinateInsideBoard(e){return e.x>=E&&e.x<=_&&e.y>=E&&e.y<=_}}function Ut(n){let e,t,o;return t=new Gt({props:{gameManager:n[0]}}),{c(){e=N("main"),ae(t.$$.fragment)},m(i,r){I(i,e,r),j(t,e,null),o=!0},p:P,i(i){o||(O(t.$$.fragment,i),o=!0)},o(i){F(t.$$.fragment,i),o=!1},d(i){i&&T(e),Z(t)}}}function Jt(n){let e={gameMode:{type:"SinglePlayerVsAi",playerColor:u.WHITE,algorithmOption:new Dt(new xt),timeFormat:{white:{secondsIncrement:0,secondsStartTime:300},black:{secondsIncrement:0,secondsStartTime:600}}},FEN:null},t={gameMode:{type:"SinglePlayerVsAi",playerColor:u.BLACK,algorithmOption:new Ye(new pe),timeFormat:{white:{secondsIncrement:0,secondsStartTime:300},black:{secondsIncrement:0,secondsStartTime:600}}},FEN:"7k/5n2/8/4P3/8/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1"};u.WHITE,new Ye(new pe),new Bt(new pe);let o=new Ne(e);return new Ne(t),[o]}class Qt extends oe{constructor(e){super(),te(this,e,Jt,Ut,x,{})}}new Qt({target:document.getElementById("app")});
