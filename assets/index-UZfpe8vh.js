var it=Object.defineProperty;var st=(n,e,t)=>e in n?it(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var v=(n,e,t)=>st(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();function R(){}function ze(n){return n()}function ve(){return Object.create(null)}function q(n){n.forEach(ze)}function Ye(n){return typeof n=="function"}function x(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function rt(n){return Object.keys(n).length===0}function W(n){return n??""}function N(n,e){n.appendChild(e)}function w(n,e,t){n.insertBefore(e,t||null)}function I(n){n.parentNode&&n.parentNode.removeChild(n)}function ee(n,e){for(let t=0;t<n.length;t+=1)n[t]&&n[t].d(e)}function A(n){return document.createElement(n)}function B(n){return document.createTextNode(n)}function H(){return B(" ")}function le(){return B("")}function se(n,e,t,o){return n.addEventListener(e,t,o),()=>n.removeEventListener(e,t,o)}function at(n){return function(e){return e.stopPropagation(),n.call(this,e)}}function E(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function lt(n){return Array.from(n.childNodes)}function Y(n,e){e=""+e,n.data!==e&&(n.data=e)}function ne(n,e,t,o){t==null?n.style.removeProperty(e):n.style.setProperty(e,t,"")}function M(n,e,t){n.classList.toggle(e,!!t)}function ct(n,e,{bubbles:t=!1,cancelable:o=!1}={}){return new CustomEvent(n,{detail:e,bubbles:t,cancelable:o})}let re;function ie(n){re=n}function ht(){if(!re)throw new Error("Function called outside component initialization");return re}function ke(){const n=ht();return(e,t,{cancelable:o=!1}={})=>{const i=n.$$.callbacks[e];if(i){const r=ct(e,t,{cancelable:o});return i.slice().forEach(s=>{s.call(n,r)}),!r.defaultPrevented}return!0}}const Q=[],Ee=[];let X=[];const Se=[],Xe=Promise.resolve();let ge=!1;function je(){ge||(ge=!0,Xe.then(Ze))}function ft(){return je(),Xe}function me(n){X.push(n)}const pe=new Set;let J=0;function Ze(){if(J!==0)return;const n=re;do{try{for(;J<Q.length;){const e=Q[J];J++,ie(e),ut(e.$$)}}catch(e){throw Q.length=0,J=0,e}for(ie(null),Q.length=0,J=0;Ee.length;)Ee.pop()();for(let e=0;e<X.length;e+=1){const t=X[e];pe.has(t)||(pe.add(t),t())}X.length=0}while(Q.length);for(;Se.length;)Se.pop()();ge=!1,pe.clear(),ie(n)}function ut(n){if(n.fragment!==null){n.update(),q(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(me)}}function dt(n){const e=[],t=[];X.forEach(o=>n.indexOf(o)===-1?e.push(o):t.push(o)),t.forEach(o=>o()),X=e}const ue=new Set;let $;function qe(){$={r:0,c:[],p:$}}function et(){$.r||q($.c),$=$.p}function K(n,e){n&&n.i&&(ue.delete(n),n.i(e))}function F(n,e,t,o){if(n&&n.o){if(ue.has(n))return;ue.add(n),$.c.push(()=>{ue.delete(n),o&&(t&&n.d(1),o())}),n.o(e)}else o&&o()}function P(n){return(n==null?void 0:n.length)!==void 0?n:Array.from(n)}function ae(n){n&&n.c()}function j(n,e,t){const{fragment:o,after_update:i}=n.$$;o&&o.m(e,t),me(()=>{const r=n.$$.on_mount.map(ze).filter(Ye);n.$$.on_destroy?n.$$.on_destroy.push(...r):q(r),n.$$.on_mount=[]}),i.forEach(me)}function Z(n,e){const t=n.$$;t.fragment!==null&&(dt(t.after_update),q(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function pt(n,e){n.$$.dirty[0]===-1&&(Q.push(n),je(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function te(n,e,t,o,i,r,s=null,l=[-1]){const c=re;ie(n);const a=n.$$={fragment:null,ctx:[],props:r,update:R,not_equal:i,bound:ve(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(c?c.$$.context:[])),callbacks:ve(),dirty:l,skip_bound:!1,root:e.target||c.$$.root};s&&s(a.root);let h=!1;if(a.ctx=t?t(n,e.props||{},(f,d,...g)=>{const k=g.length?g[0]:d;return a.ctx&&i(a.ctx[f],a.ctx[f]=k)&&(!a.skip_bound&&a.bound[f]&&a.bound[f](k),h&&pt(n,f)),d}):[],a.update(),h=!0,q(a.before_update),a.fragment=o?o(a.ctx):!1,e.target){if(e.hydrate){const f=lt(e.target);a.fragment&&a.fragment.l(f),f.forEach(I)}else a.fragment&&a.fragment.c();e.intro&&K(n.$$.fragment),j(n,e.target,e.anchor),Ze()}ie(c)}class oe{constructor(){v(this,"$$");v(this,"$$set")}$destroy(){Z(this,1),this.$destroy=R}$on(e,t){if(!Ye(t))return R;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(t),()=>{const i=o.indexOf(t);i!==-1&&o.splice(i,1)}}$set(e){this.$$set&&!rt(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const gt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(gt);var p=(n=>(n.PAWN="PAWN",n.KNIGHT="KNIGHT",n.BISHOP="BISHOP",n.ROOK="ROOK",n.QUEEN="QUEEN",n.KING="KING",n))(p||{}),u=(n=>(n.WHITE="WHITE",n.BLACK="BLACK",n))(u||{}),y=(n=>(n.east="east",n.southEast="southEast",n.south="south",n.southWest="southWest",n.west="west",n.northWest="northWest",n.north="north",n.northEast="northEast",n))(y||{}),z=(n=>(n.WHITE_VICTORY="WHITE_VICTORY",n.BLACK_VICTORY="BLACK_VICTORY",n.DRAW="DRAW",n.DRAW_50_MOVE_RULE="DRAW_50_MOVE_RULE",n.DRAW_THREEFOLD_REPETITION="DRAW_THREEFOLD_REPETITION",n))(z||{});const D=8,_=D-1,S=0,fe=4,mt=n=>{if(n===u.BLACK)return"black";if(n===u.WHITE)return"white";throw new Error("Unknown player color!")},V={east:{x:1,y:0},southEast:{x:1,y:-1},south:{x:0,y:-1},southWest:{x:-1,y:-1},west:{x:-1,y:0},northWest:{x:-1,y:1},north:{x:0,y:1},northEast:{x:1,y:1}},yt=n=>{const e=n.color===u.WHITE?1:-1;return de(n)*e},de=n=>{switch(n.type){case p.BISHOP:case p.KNIGHT:return 3;case p.PAWN:return 1;case p.ROOK:return 5;case p.QUEEN:return 9;default:return 0}},Ce=1e4,Me=-1e4,kt=-1e3,_t=1e3,Te=.06,Ie=.09,bt=.04,vt=.02,Et=.03,St=.01,Ct=.001,Mt=.02,we=(n,e)=>{if(n.to.piece&&!e.to.piece)return-1;if(!n.to.piece&&e.to.piece)return 1;const t=de(e.from.piece)-de(n.from.piece);if(t!=0)return t;const o=n.from.piece.color===u.WHITE?n.from.y:_-n.from.y,r=(e.from.piece.color===u.WHITE?e.from.y:_-e.from.y)-o;if(r!=0)return r;const s=fe-Math.abs(n.from.x-fe);return fe-Math.abs(e.from.x-fe)-s};class _e{constructor(e,t,o,i,r,s,l,c){v(this,"board");v(this,"playerTurn");v(this,"castleRights");v(this,"enPassant");v(this,"halfmoveClock");v(this,"fullmoveNumber");v(this,"attacks");v(this,"legalMoves");this.legalMoves=c??[],this.board=e,this.playerTurn=t,this.castleRights=o,this.enPassant=i,this.halfmoveClock=r,this.fullmoveNumber=s,this.attacks=l??{white:[],black:[]},this.attacks=this.getAttacks(),c||this.updateLegalMoves()}getLegalMoves(){return this.legalMoves}updateLegalMoves(){this.legalMoves=this.board.map(e=>e.filter(t=>t.piece!=null&&t.piece.color===this.playerTurn).map(t=>this.getLegalMovesForPiece(t))).flat(2).filter(e=>!this.kingIsInCheck(e))}makeMove(e,t){this.board[e.from.y][e.from.x]={...this.board[e.from.y][e.from.x],piece:null},this.board[e.to.y][e.to.x]={...this.board[e.to.y][e.to.x],piece:e.from.piece},this.playerTurn=this.playerTurn===u.WHITE?u.BLACK:u.WHITE,this.halfmoveClock=e.from.piece.type===p.PAWN||e.to.piece!=null?0:this.halfmoveClock+1,e.from.piece.color===u.BLACK&&this.fullmoveNumber++,this.isCastlingMove(e)&&this.completeCastleMove(e),this.isEnPassantCapture(e)&&this.completeEnPassantCapture(e),e.promotion&&(this.board[e.to.y][e.to.x]={...this.board[e.to.y][e.to.x],piece:{...e.from.piece,type:e.promotion}}),this.updateEnPassantTarget(e),this.updateCastleRights(e),this.updateAttacks(),t||this.updateLegalMoves()}updateEnPassantTarget(e){this.enPassant=e.from.piece.type===p.PAWN&&Math.abs(e.from.y-e.to.y)===2?e.to.notation:null}updateCastleRights(e){const t=e.from.piece.color,o=mt(t);e.from.piece.type===p.KING&&(this.castleRights[o]={queenSide:!1,kingSide:!1}),e.from.piece.type===p.ROOK&&(this.castleRights[o]={queenSide:e.from.x===S?!1:this.castleRights[o].queenSide,kingSide:e.from.x===_?!1:this.castleRights[o].kingSide}),e.to.notation==="a1"&&(this.castleRights.white.queenSide=!1),e.to.notation==="h1"&&(this.castleRights.white.kingSide=!1),e.to.notation==="a8"&&(this.castleRights.black.queenSide=!1),e.to.notation==="h8"&&(this.castleRights.black.kingSide=!1)}completeCastleMove(e){const t=e.to.x;if(t!=2&&t!=6)throw new Error("Invalid castle move, x index is "+t);const o=e.from.piece.color===u.WHITE?S:_,i=t===2?0:7;this.board[o][i]={...this.board[o][i],piece:null};const r=t===2?3:5;this.board[o][r]={...this.board[o][r],piece:{type:p.ROOK,color:e.from.piece.color}}}completeEnPassantCapture(e){const t=e.to.x,o=e.from.y;this.board[o][t]={...this.board[o][t],piece:null}}isPawnPushMove(e){return e.from.piece.type===p.PAWN&&e.from.y!=e.to.y&&e.from.x===e.to.x}isEnPassantCapture(e){return e.from.piece.type===p.PAWN&&e.from.x!=e.to.x&&e.to.piece==null}isCastlingMove(e){var t;return((t=e.from.piece)==null?void 0:t.type)!==p.KING?!1:e.from.piece.color===u.WHITE?e.to.notation==="g1"&&e.from.notation==="e1"||e.to.notation==="c1"&&e.from.notation==="e1":e.to.notation==="g8"&&e.from.notation==="e8"||e.to.notation==="c8"&&e.from.notation==="e8"}getAttacks(){return this.updateAttacks(),this.attacks}updateAttacks(){const e=this.board.map(t=>t.map(o=>{if(o.piece===null)return[];const i=o;return this.getAttacksForPiece(i)})).flat(2);this.attacks.white=e.filter(t=>t.attacker.piece.color===u.WHITE),this.attacks.black=e.filter(t=>t.attacker.piece.color===u.BLACK)}oppesideKingInCheck(){return this.kingInCheck(this.playerTurn===u.WHITE?u.BLACK:u.WHITE)}ownKingInCheck(){return this.kingInCheck(this.playerTurn)}kingInCheck(e){const t=this.findSquare(i=>i.piece!=null&&i.piece.type===p.KING&&i.piece.color===e);return(e===u.WHITE?this.attacks.black:this.attacks.white).some(i=>i.attackTarget.notation===t.notation)}kingIsInCheck(e){const t=this.clone();return t.makeMove(e,!0),t.oppesideKingInCheck()}getAttacksForPiece(e){if(e.piece===null)return[];const t=e;switch(e.piece.type){case p.PAWN:return this.getDirectPawnAttacks(t);case p.KNIGHT:return this.getDirectKnightAttacks(t);case p.BISHOP:return this.getDirectBishopAttacks(t);case p.ROOK:return this.getDirectRookAttacks(t);case p.QUEEN:return this.getDirectQueenAttacks(t);case p.KING:return this.getDirectKingAttacks(t)}}getDirectKingAttacks(e){const t=[y.east,y.west,y.north,y.south,y.northEast,y.northWest,y.southEast,y.southWest],o=s=>!0,i=s=>!0;return t.map(s=>this.getSquaresUntilCondition(e,V[s],o,i)).flat().map(s=>({attackTarget:s,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectQueenAttacks(e){return this.getDirectBishopAttacks(e).concat(this.getDirectRookAttacks(e))}getDirectRookAttacks(e){const t=s=>!0,o=s=>s.piece!=null;return[y.east,y.west,y.south,y.north].map(s=>this.getSquaresUntilCondition(e,V[s],t,o)).flat().map(s=>({attackTarget:s,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectBishopAttacks(e){const t=s=>!0,o=s=>s.piece!=null;return[y.northEast,y.northWest,y.southEast,y.southWest].map(s=>this.getSquaresUntilCondition(e,V[s],t,o)).flat().map(s=>({attackTarget:s,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectKnightAttacks(e){const t=o=>!0;return this.getKnightMoves(e,t).map(o=>({attackTarget:o,attacker:{piece:e.piece,pieceSquare:e}}))}getDirectPawnAttacks(e){let t=[];return e.piece.color===u.WHITE?(e.y+1<=_&&e.x+1<=_&&t.push(this.board[e.y+1][e.x+1]),e.y+1<=_&&e.x-1>=S&&t.push(this.board[e.y+1][e.x-1])):e.piece.color===u.BLACK&&(e.y-1>=S&&e.x+1<=_&&t.push(this.board[e.y-1][e.x+1]),e.y-1>=S&&e.x-1>=S&&t.push(this.board[e.y-1][e.x-1])),t.map(o=>({attackTarget:o,attacker:{piece:e.piece,pieceSquare:e}}))}getLegalMovesForPiece(e){if(e.piece===null)return[];const t=e;switch(e.piece.type){case p.PAWN:return this.getLegalPawnMoves(t);case p.KNIGHT:return this.getLegalKnightMoves(t);case p.BISHOP:return this.getLegalBishopMoves(t);case p.ROOK:return this.getLegalRookMoves(t);case p.QUEEN:return this.getLegalQueenMoves(t);case p.KING:return this.getLegalKingMoves(t)}}getLegalPawnMoves(e){var l,c,a,h;let t=[];e.piece.color===u.WHITE?(e.y+1<=_&&this.board[e.y+1][e.x].piece==null&&t.push(this.board[e.y+1][e.x]),e.y+1<=_&&e.x+1<=_&&(((l=this.board[e.y+1][e.x+1].piece)==null?void 0:l.color)===u.BLACK||this.board[e.y][e.x+1].notation===this.enPassant)&&t.push(this.board[e.y+1][e.x+1]),e.y+1<=_&&e.x-1>=S&&(((c=this.board[e.y+1][e.x-1].piece)==null?void 0:c.color)===u.BLACK||this.board[e.y][e.x-1].notation===this.enPassant)&&t.push(this.board[e.y+1][e.x-1]),e.y===1&&this.board[e.y+1][e.x].piece==null&&this.board[e.y+2][e.x].piece==null&&t.push(this.board[e.y+2][e.x])):e.piece.color===u.BLACK&&(e.y-1>=S&&this.board[e.y-1][e.x].piece==null&&t.push(this.board[e.y-1][e.x]),e.y-1>=S&&e.x+1<=_&&(((a=this.board[e.y-1][e.x+1].piece)==null?void 0:a.color)===u.WHITE||this.board[e.y][e.x+1].notation===this.enPassant)&&t.push(this.board[e.y-1][e.x+1]),e.y-1>=S&&e.x-1>=S&&(((h=this.board[e.y-1][e.x-1].piece)==null?void 0:h.color)===u.WHITE||this.board[e.y][e.x-1].notation===this.enPassant)&&t.push(this.board[e.y-1][e.x-1]),e.y===6&&this.board[e.y-1][e.x].piece==null&&this.board[e.y-2][e.x].piece==null&&t.push(this.board[e.y-2][e.x]));const o=t.filter(f=>e.piece.color===u.WHITE&&f.y===_||e.piece.color===u.BLACK&&f.y===S),i=t.filter(f=>!o.some(d=>d.notation===f.notation)),r=o.map(f=>[p.BISHOP,p.KNIGHT,p.ROOK,p.QUEEN].map(g=>({from:e,to:f,promotion:g}))).flat(2),s=i.map(f=>({from:e,to:f}));return r.concat(s)}getLegalKnightMoves(e){const t=o=>o.piece==null||o.piece.color!=e.piece.color;return this.getKnightMoves(e,t).map(o=>({from:e,to:o}))}getLegalBishopMoves(e){const t=[y.northEast,y.northWest,y.southEast,y.southWest],o=s=>s.piece==null||s.piece.color!=e.piece.color,i=s=>s.piece!=null;return t.map(s=>this.getSquaresUntilCondition(e,V[s],o,i)).flat().map(s=>({from:e,to:s}))}getLegalRookMoves(e){const t=[y.east,y.west,y.north,y.south],o=s=>s.piece==null||s.piece.color!=e.piece.color,i=s=>s.piece!=null;return t.map(s=>this.getSquaresUntilCondition(e,V[s],o,i)).flat().map(s=>({from:e,to:s}))}getLegalQueenMoves(e){return this.getLegalBishopMoves(e).concat(this.getLegalRookMoves(e))}canCastleQueenSide(e){return e.piece.color===u.WHITE&&this.castleRights.white.queenSide&&e.notation==="e1"&&this.board[0][1].piece==null&&this.board[0][2].piece==null&&this.board[0][3].piece==null&&!this.kingInCheck(u.WHITE)&&!this.attacks.black.some(t=>t.attackTarget.y===S&&[1,2,3].some(o=>o===t.attackTarget.x))||e.piece.color===u.BLACK&&this.castleRights.black.queenSide&&e.notation==="e8"&&this.board[7][1].piece==null&&this.board[7][2].piece==null&&this.board[7][3].piece==null&&!this.kingInCheck(u.BLACK)&&!this.attacks.white.some(t=>t.attackTarget.y===_&&[1,2,3].some(o=>o===t.attackTarget.x))}canCastleKingSide(e){return e.piece.color===u.WHITE&&this.castleRights.white.kingSide&&e.notation==="e1"&&this.board[0][5].piece==null&&this.board[0][6].piece==null&&!this.kingInCheck(u.WHITE)&&!this.attacks.black.some(t=>t.attackTarget.y===S&&[5,6].some(o=>o===t.attackTarget.x))||e.piece.color===u.BLACK&&this.castleRights.black.kingSide&&e.notation==="e8"&&this.board[7][5].piece==null&&this.board[7][6].piece==null&&!this.kingInCheck(u.BLACK)&&!this.attacks.white.some(t=>t.attackTarget.y===_&&[5,6].some(o=>o===t.attackTarget.x))}getLegalKingMoves(e){const t=[y.east,y.west,y.north,y.south,y.northEast,y.northWest,y.southEast,y.southWest],o=l=>l.piece==null||l.piece.color!=e.piece.color,i=l=>!0,r=t.map(l=>this.getSquaresUntilCondition(e,V[l],o,i)).flat();let s=[];return this.canCastleKingSide(e)&&s.push(this.board[e.piece.color===u.WHITE?S:_][6]),this.canCastleQueenSide(e)&&s.push(this.board[e.piece.color===u.WHITE?S:_][2]),r.concat(s).map(l=>({from:e,to:l}))}coordinateInsideBoard(e){return e.x>=S&&e.x<=_&&e.y>=S&&e.y<=_}getKnightMoves(e,t){return[{x:e.x+2,y:e.y+1},{x:e.x+2,y:e.y-1},{x:e.x-2,y:e.y+1},{x:e.x-2,y:e.y-1},{x:e.x+1,y:e.y+2},{x:e.x+1,y:e.y-2},{x:e.x-1,y:e.y+2},{x:e.x-1,y:e.y-2}].filter(this.coordinateInsideBoard).map(i=>this.board[i.y][i.x]).filter(t)}getSquaresUntilCondition(e,t,o,i){let r={x:e.x+t.x,y:e.y+t.y},s=[];for(;this.coordinateInsideBoard(r);){const l=this.board[r.y][r.x];if(o(l)&&s.push(l),i(l))break;r.x+=t.x,r.y+=t.y}return s}clone(){return new _e(JSON.parse(JSON.stringify(this.board)),JSON.parse(JSON.stringify(this.playerTurn)),JSON.parse(JSON.stringify(this.castleRights)),JSON.parse(JSON.stringify(this.enPassant)),JSON.parse(JSON.stringify(this.halfmoveClock)),JSON.parse(JSON.stringify(this.fullmoveNumber)),JSON.parse(JSON.stringify(this.attacks)),JSON.parse(JSON.stringify(this.legalMoves)))}squareExists(e){return this.findSquares(e).length>0}findSquare(e){const t=this.findSquares(e);if(t.length===0||t.length>1)throw new Error("Find square makes the assumption that the search should return one, and only one result, but number of restults where/was "+JSON.stringify(t));return t[0]}findSquares(e){return this.board.map(t=>t.filter(e)).flat(2)}}class Tt{constructor(e){v(this,"defaultFen","rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");v(this,"fen");v(this,"chessGame");v(this,"gameConfig");v(this,"history");v(this,"result");v(this,"threefoldRepetitionStack");v(this,"log",{game:()=>console.log("Game: ",this.chessGame),board:()=>console.log("Game board: ",this.chessGame.board),fen:()=>console.log("Game as fen: ",this.toFen()),custom:()=>console.log("custom",this.chessGame.board[1][2])});this.fen=e.FEN??this.defaultFen,this.gameConfig=e,this.chessGame=this.toGame(),this.result=null,this.history=[],this.threefoldRepetitionStack=[],this.pushToHistory(),this.checkShouldStopGame(),this.checkAndHandleSinglePlayerMove(),e.gameMode.type==="AiVsAi"&&this.autoPlay(0)}toFen(){return[this.getBoardFen(),this.getPlayerFen(),this.getCastleRightsFen(),this.getEnPassantFen(),this.getHalfmoveClockFen(),this.getFullmoveNumberFen()].reduce((t,o)=>t+(t.length>0?" ":"")+o,"")}toGame(){return new _e(this.getBoardFromFen(),this.getPlayerTurnFromFen(),this.getCastleRightsFromFen(),this.getEnPassantFromFen(),this.getHalfmoveClockFromFen(),this.getFullmoveNumberFromFen())}getLegalMoves(){return this.chessGame.getLegalMoves()}makeMove(e){if(this.checkShouldStopGame())return;const t=this.getLegalMoves();if(!t.some(i=>i.from.notation===e.from.notation&&i.to.notation===e.to.notation&&i.promotion==e.promotion)){console.log("Illegal move!",e,t.filter(i=>i.from.piece.type===p.KING));return}this.chessGame.makeMove(e),this.pushToHistory(e),this.updateThreefoldRepetition(),this.checkShouldStopGame()}updateThreefoldRepetition(){let e={board:JSON.parse(JSON.stringify(this.chessGame.board)),legalMoves:this.getLegalMoves()};const t=this.threefoldRepetitionStack.findIndex(o=>{const i=o.position.board.flat().every(s=>this.chessGame.squareExists(l=>{var c,a,h,f;return l.notation===s.notation&&((c=l.piece)==null?void 0:c.color)===((a=s.piece)==null?void 0:a.color)&&((h=l.piece)==null?void 0:h.type)===((f=s.piece)==null?void 0:f.type)})),r=o.position.legalMoves.length===e.legalMoves.length&&o.position.legalMoves.every(s=>e.legalMoves.some(l=>{var c,a,h,f;return l.from.notation===s.from.notation&&l.to.notation===s.to.notation&&l.promotion===s.promotion&&((c=l.from.piece)==null?void 0:c.type)===((a=s.from.piece)==null?void 0:a.type)&&((h=l.from.piece)==null?void 0:h.color)===((f=s.from.piece)==null?void 0:f.color)}));return i&&r});t>=0?this.threefoldRepetitionStack[t].timesReached++:this.threefoldRepetitionStack.push({position:e,timesReached:1})}threefoldRepetitionReached(){return this.threefoldRepetitionStack.filter(e=>e.timesReached>=3).length>0}async checkAndHandleSinglePlayerMove(){if(!this.checkShouldStopGame()&&this.gameConfig.gameMode.type==="SinglePlayerVsAi"&&this.chessGame.playerTurn!==this.gameConfig.gameMode.playerColor&&!this.result){const e=await this.gameConfig.gameMode.algorithmOption.motor.getMove(this.chessGame,this.threefoldRepetitionStack,0,this.gameConfig.gameMode.algorithmOption.depth);this.makePreCheckedMove(e),this.checkShouldStopGame()}}checkShouldStopGame(){return this.updateResult(),this.result!=null}updateResult(){this.getLegalMoves().length===0?this.result=this.chessGame.ownKingInCheck()?this.chessGame.playerTurn===u.WHITE?z.BLACK_VICTORY:z.WHITE_VICTORY:z.DRAW:this.chessGame.halfmoveClock>=50?this.result=z.DRAW_50_MOVE_RULE:this.threefoldRepetitionReached()&&(this.result=z.DRAW_THREEFOLD_REPETITION)}async autoPlay(e){if(!(e>1e3)&&this.gameConfig.gameMode.type=="AiVsAi"&&!this.checkShouldStopGame()){if(this.chessGame.playerTurn===u.WHITE){const t=await this.gameConfig.gameMode.algorithmOptions.white.motor.getMove(this.chessGame,this.threefoldRepetitionStack,0,this.gameConfig.gameMode.algorithmOptions.white.depth);this.makePreCheckedMove(t)}else{const t=await this.gameConfig.gameMode.algorithmOptions.black.motor.getMove(this.chessGame,this.threefoldRepetitionStack,0,this.gameConfig.gameMode.algorithmOptions.black.depth);this.makePreCheckedMove(t)}e+=1,this.autoPlay(e)}}makePreCheckedMove(e){this.chessGame.makeMove(e),this.pushToHistory(e),this.updateThreefoldRepetition()}pushToHistory(e){this.history.push({game:this.chessGame.clone(),move:e??null})}getBoardFromFen(){let e=Array.from({length:D},(s,l)=>Array.from({length:D},(c,a)=>({x:a,y:l,piece:null,notation:this.getNotation(a,l)})));const o=this.fen.split(" ")[0].split("/"),i=s=>{switch(s.toLowerCase()){case"p":return p.PAWN;case"r":return p.ROOK;case"n":return p.KNIGHT;case"b":return p.BISHOP;case"q":return p.QUEEN;case"k":return p.KING;default:throw new Error("Fen char <"+s+"> is not a valid pieceType!")}},r=(s,l,c,a,h)=>{if(l>D)throw new Error("Out of bound in fen board parsing.");if(l>_)return;const f=s.charAt(h);if(isNaN(Number(f)))return c[_-a][l].piece={color:f==f.toUpperCase()?u.WHITE:u.BLACK,type:i(f)},l++,h++,r(s,l,c,a,h);const d=Number(f);return l+=d,h++,r(s,l,c,a,h)};return o.forEach((s,l)=>r(s,0,e,l,0)),e}getPlayerTurnFromFen(){return this.fen.split(" ")[1]==="w"?u.WHITE:u.BLACK}getCastleRightsFromFen(){const e=this.fen.split(" ")[2];return{white:{queenSide:e.includes("Q"),kingSide:e.includes("K")},black:{queenSide:e.includes("q"),kingSide:e.includes("k")}}}getEnPassantFromFen(){const e=this.fen.split(" ")[3];return e==="-"?null:e}getHalfmoveClockFromFen(){return Number(this.fen.split(" ")[4])}getFullmoveNumberFromFen(){return Number(this.fen.split(" ")[5])}getBoardFen(){const e=o=>{let i;switch(o.type){case p.PAWN:i="p";break;case p.KNIGHT:i="n";break;case p.BISHOP:i="b";break;case p.ROOK:i="r";break;case p.QUEEN:i="q";break;case p.KING:i="k";break;default:throw new Error("Invalid pieceType found in conversion to fen!")}return o.color===u.WHITE?i.toUpperCase():i},t=(o,i,r)=>{if(o>D)throw new Error("Index out of bounds while converting board to fen!");if(o>_)return r>0?r+"":"";const s=i[o];return o++,s.piece?(r>0?r+"":"")+e(s.piece)+t(o,i,0):(r++,t(o,i,r))};return[...this.chessGame.board].reverse().map(o=>t(0,o,0)).reduce((o,i)=>o+(o.length>0?"/":"")+i,"")}getPlayerFen(){return this.chessGame.playerTurn===u.WHITE?"w":"b"}getCastleRightsFen(){const e=this.chessGame.castleRights;if(!(e.black.kingSide||e.black.queenSide||e.white.kingSide||e.white.queenSide))return"-";let t="";return t+=e.white.kingSide?"K":"",t+=e.white.queenSide?"Q":"",t+=e.black.kingSide?"k":"",t+=e.black.queenSide?"q":"",t}getEnPassantFen(){return this.chessGame.enPassant==null?"-":this.chessGame.enPassant}getHalfmoveClockFen(){return this.chessGame.halfmoveClock+""}getFullmoveNumberFen(){return this.chessGame.fullmoveNumber+""}getNotation(e,t){let o="";switch(e){case 0:o="a";break;case 1:o="b";break;case 2:o="c";break;case 3:o="d";break;case 4:o="e";break;case 5:o="f";break;case 6:o="g";break;case 7:o="h";break;default:throw new Error("Notation x index out of bound: "+e)}if(t<S||t>_)throw new Error("Notation y index out of bound: "+t);return o+=t+1,o}}function Ne(n,e,t){const o=n.slice();return o[4]=e[t],o[6]=t,o}function Ae(n,e,t){const o=n.slice();return o[7]=e[t],o[9]=t,o}function Re(n){let e,t=n[1]===u.WHITE&&n[7].notation.includes("a")||n[1]===u.BLACK&&n[7].notation.includes("h"),o,i=n[1]===u.WHITE&&n[7].notation.includes("1")||n[1]===u.BLACK&&n[7].notation.includes("8"),r,s,l=t&&Pe(n),c=i&&Oe(n);return{c(){e=A("div"),l&&l.c(),o=H(),c&&c.c(),r=H(),E(e,"class",s=W("notation "+n[7].notation)+" svelte-1lhqun1"),M(e,"reverse-color",(n[9]+n[6]%2)%2===0),M(e,"reverse",n[1]===u.BLACK)},m(a,h){w(a,e,h),l&&l.m(e,null),N(e,o),c&&c.m(e,null),N(e,r)},p(a,h){h&3&&(t=a[1]===u.WHITE&&a[7].notation.includes("a")||a[1]===u.BLACK&&a[7].notation.includes("h")),t?l?l.p(a,h):(l=Pe(a),l.c(),l.m(e,o)):l&&(l.d(1),l=null),h&3&&(i=a[1]===u.WHITE&&a[7].notation.includes("1")||a[1]===u.BLACK&&a[7].notation.includes("8")),i?c?c.p(a,h):(c=Oe(a),c.c(),c.m(e,r)):c&&(c.d(1),c=null),h&1&&s!==(s=W("notation "+a[7].notation)+" svelte-1lhqun1")&&E(e,"class",s),h&1&&M(e,"reverse-color",(a[9]+a[6]%2)%2===0),h&3&&M(e,"reverse",a[1]===u.BLACK)},d(a){a&&I(e),l&&l.d(),c&&c.d()}}}function Pe(n){let e,t=n[7].notation.charAt(1)+"",o;return{c(){e=A("div"),o=B(t),E(e,"class","top svelte-1lhqun1")},m(i,r){w(i,e,r),N(e,o)},p(i,r){r&1&&t!==(t=i[7].notation.charAt(1)+"")&&Y(o,t)},d(i){i&&I(e)}}}function Oe(n){let e,t=n[7].notation.charAt(0)+"",o;return{c(){e=A("div"),o=B(t),E(e,"class","bottom svelte-1lhqun1")},m(i,r){w(i,e,r),N(e,o)},p(i,r){r&1&&t!==(t=i[7].notation.charAt(0)+"")&&Y(o,t)},d(i){i&&I(e)}}}function Le(n){let e=n[1]===u.BLACK&&n[2].includes(n[7].notation)||n[1]===u.WHITE&&n[3].includes(n[7].notation),t,o=e&&Re(n);return{c(){o&&o.c(),t=le()},m(i,r){o&&o.m(i,r),w(i,t,r)},p(i,r){r&3&&(e=i[1]===u.BLACK&&i[2].includes(i[7].notation)||i[1]===u.WHITE&&i[3].includes(i[7].notation)),e?o?o.p(i,r):(o=Re(i),o.c(),o.m(t.parentNode,t)):o&&(o.d(1),o=null)},d(i){i&&I(t),o&&o.d(i)}}}function Ke(n){let e,t=P(n[4]),o=[];for(let i=0;i<t.length;i+=1)o[i]=Le(Ae(n,t,i));return{c(){for(let i=0;i<o.length;i+=1)o[i].c();e=le()},m(i,r){for(let s=0;s<o.length;s+=1)o[s]&&o[s].m(i,r);w(i,e,r)},p(i,r){if(r&15){t=P(i[4]);let s;for(s=0;s<t.length;s+=1){const l=Ae(i,t,s);o[s]?o[s].p(l,r):(o[s]=Le(l),o[s].c(),o[s].m(e.parentNode,e))}for(;s<o.length;s+=1)o[s].d(1);o.length=t.length}},d(i){i&&I(e),ee(o,i)}}}function It(n){let e,t=P(n[0]),o=[];for(let i=0;i<t.length;i+=1)o[i]=Ke(Ne(n,t,i));return{c(){for(let i=0;i<o.length;i+=1)o[i].c();e=le()},m(i,r){for(let s=0;s<o.length;s+=1)o[s]&&o[s].m(i,r);w(i,e,r)},p(i,[r]){if(r&15){t=P(i[0]);let s;for(s=0;s<t.length;s+=1){const l=Ne(i,t,s);o[s]?o[s].p(l,r):(o[s]=Ke(l),o[s].c(),o[s].m(e.parentNode,e))}for(;s<o.length;s+=1)o[s].d(1);o.length=t.length}},i:R,o:R,d(i){i&&I(e),ee(o,i)}}}function wt(n,e,t){let{board:o}=e,{playerColor:i}=e,r=["h8","h7","h6","h5","h4","h3","h2","h1","g8","f8","e8","d8","c8","b8","a8"],s=["a8","a7","a6","a5","a4","a3","a2","h1","g1","f1","e1","d1","c1","b1","a1"];return n.$$set=l=>{"board"in l&&t(0,o=l.board),"playerColor"in l&&t(1,i=l.playerColor)},[o,i,r,s]}class Nt extends oe{constructor(e){super(),te(this,e,wt,It,x,{board:0,playerColor:1})}}function He(n,e,t){const o=n.slice();return o[5]=e[t],o}function We(n){let e,t,o,i;function r(){return n[3](n[5])}return{c(){e=A("button"),E(e,"class",t=W("selection "+n[0].from.piece.color.toLowerCase()+" "+n[5])+" svelte-rshfpz")},m(s,l){w(s,e,l),o||(i=se(e,"click",r),o=!0)},p(s,l){n=s,l&1&&t!==(t=W("selection "+n[0].from.piece.color.toLowerCase()+" "+n[5])+" svelte-rshfpz")&&E(e,"class",t)},d(s){s&&I(e),o=!1,i()}}}function At(n){let e,t,o,i=P(n[2]),r=[];for(let s=0;s<i.length;s+=1)r[s]=We(He(n,i,s));return{c(){e=A("div"),t=A("div");for(let s=0;s<r.length;s+=1)r[s].c();E(t,"class","selections svelte-rshfpz"),E(e,"class",o=W("promotionSelect "+n[0].to.notation)+" svelte-rshfpz"),M(e,"reverse",n[0].from.piece.color===u.BLACK)},m(s,l){w(s,e,l),N(e,t);for(let c=0;c<r.length;c+=1)r[c]&&r[c].m(t,null)},p(s,[l]){if(l&7){i=P(s[2]);let c;for(c=0;c<i.length;c+=1){const a=He(s,i,c);r[c]?r[c].p(a,l):(r[c]=We(a),r[c].c(),r[c].m(t,null))}for(;c<r.length;c+=1)r[c].d(1);r.length=i.length}l&1&&o!==(o=W("promotionSelect "+s[0].to.notation)+" svelte-rshfpz")&&E(e,"class",o),l&1&&M(e,"reverse",s[0].from.piece.color===u.BLACK)},i:R,o:R,d(s){s&&I(e),ee(r,s)}}}function Rt(n,e,t){let{move:o}=e;const i=ke();function r(c){i("promotionSelected",{...o,promotion:c})}const s=[p.BISHOP,p.KNIGHT,p.ROOK,p.QUEEN],l=c=>r(c);return n.$$set=c=>{"move"in c&&t(0,o=c.move)},[o,r,s,l]}class Pt extends oe{constructor(e){super(),te(this,e,Rt,At,x,{move:0})}}function Ge(n,e,t){const o=n.slice();return o[18]=e[t],o}function Be(n,e,t){const o=n.slice();return o[21]=e[t],o}function Fe(n){let e,t;return e=new Pt({props:{move:n[6]}}),e.$on("promotionSelected",n[10]),{c(){ae(e.$$.fragment)},m(o,i){j(e,o,i),t=!0},p(o,i){const r={};i&64&&(r.move=o[6]),e.$set(r)},i(o){t||(K(e.$$.fragment,o),t=!0)},o(o){F(e.$$.fragment,o),t=!1},d(o){Z(e,o)}}}function $e(n){let e,t,o,i,r,s;function l(...c){return n[11](n[21],...c)}return{c(){var c,a,h,f;e=A("div"),E(e,"id",t=n[21].notation),E(e,"class",o=W("square "+n[21].notation+" "+(((c=n[21].piece)==null?void 0:c.type)??""))+" svelte-13dsv2q"),E(e,"role","presentation"),E(e,"style",i=n[3]===n[21].notation?`transform: translate(${n[4]}%,${n[5]}%);`:""),M(e,"hide-piece",((a=n[6])==null?void 0:a.from.notation)===n[21].notation),M(e,"attacked",n[1].attacks.white.some(l)),M(e,"reverse",n[2]===u.BLACK),M(e,"piece",n[21].piece!=null),M(e,"white",((h=n[21].piece)==null?void 0:h.color)===u.WHITE),M(e,"black",((f=n[21].piece)==null?void 0:f.color)===u.BLACK),M(e,"dragging",n[3]===n[21].notation)},m(c,a){w(c,e,a),r||(s=se(e,"mousedown",n[7]),r=!0)},p(c,a){var h,f,d,g;n=c,a&2&&t!==(t=n[21].notation)&&E(e,"id",t),a&2&&o!==(o=W("square "+n[21].notation+" "+(((h=n[21].piece)==null?void 0:h.type)??""))+" svelte-13dsv2q")&&E(e,"class",o),a&58&&i!==(i=n[3]===n[21].notation?`transform: translate(${n[4]}%,${n[5]}%);`:"")&&E(e,"style",i),a&66&&M(e,"hide-piece",((f=n[6])==null?void 0:f.from.notation)===n[21].notation),a&2&&M(e,"attacked",n[1].attacks.white.some(l)),a&6&&M(e,"reverse",n[2]===u.BLACK),a&2&&M(e,"piece",n[21].piece!=null),a&2&&M(e,"white",((d=n[21].piece)==null?void 0:d.color)===u.WHITE),a&2&&M(e,"black",((g=n[21].piece)==null?void 0:g.color)===u.BLACK),a&10&&M(e,"dragging",n[3]===n[21].notation)},d(c){c&&I(e),r=!1,s()}}}function De(n){let e,t=P(n[18]),o=[];for(let i=0;i<t.length;i+=1)o[i]=$e(Be(n,t,i));return{c(){for(let i=0;i<o.length;i+=1)o[i].c();e=le()},m(i,r){for(let s=0;s<o.length;s+=1)o[s]&&o[s].m(i,r);w(i,e,r)},p(i,r){if(r&254){t=P(i[18]);let s;for(s=0;s<t.length;s+=1){const l=Be(i,t,s);o[s]?o[s].p(l,r):(o[s]=$e(l),o[s].c(),o[s].m(e.parentNode,e))}for(;s<o.length;s+=1)o[s].d(1);o.length=t.length}},d(i){i&&I(e),ee(o,i)}}}function Ot(n){let e,t,o,i,r,s,l,c;o=new Nt({props:{board:n[1].board,playerColor:n[2]}});let a=n[6]&&Fe(n),h=P(n[1].board),f=[];for(let d=0;d<h.length;d+=1)f[d]=De(Ge(n,h,d));return{c(){e=A("div"),t=A("div"),ae(o.$$.fragment),i=H(),a&&a.c(),r=H();for(let d=0;d<f.length;d+=1)f[d].c();E(t,"id","board-background"),E(t,"class","board svelte-13dsv2q"),ne(t,"width",n[0]+"px"),ne(t,"height",n[0]+"px"),E(e,"class","chess-board-layout svelte-13dsv2q")},m(d,g){w(d,e,g),N(e,t),j(o,t,null),N(t,i),a&&a.m(t,null),N(t,r);for(let k=0;k<f.length;k+=1)f[k]&&f[k].m(t,null);s=!0,l||(c=[se(window,"mouseup",n[9]),se(window,"mousemove",n[8])],l=!0)},p(d,[g]){const k={};if(g&2&&(k.board=d[1].board),g&4&&(k.playerColor=d[2]),o.$set(k),d[6]?a?(a.p(d,g),g&64&&K(a,1)):(a=Fe(d),a.c(),K(a,1),a.m(t,r)):a&&(qe(),F(a,1,1,()=>{a=null}),et()),g&254){h=P(d[1].board);let b;for(b=0;b<h.length;b+=1){const T=Ge(d,h,b);f[b]?f[b].p(T,g):(f[b]=De(T),f[b].c(),f[b].m(t,null))}for(;b<f.length;b+=1)f[b].d(1);f.length=h.length}(!s||g&1)&&ne(t,"width",d[0]+"px"),(!s||g&1)&&ne(t,"height",d[0]+"px")},i(d){s||(K(o.$$.fragment,d),K(a),s=!0)},o(d){F(o.$$.fragment,d),F(a),s=!1},d(d){d&&I(e),Z(o),a&&a.d(),ee(f,d),l=!1,q(c)}}}function Lt(n,e,t){let{boardSize:o}=e,{chessGame:i}=e,{playerColor:r}=e,s,l,c,a=null;const h=ke(),f=m=>{let C=m.target;d(C,m)},d=(m,C)=>{var be;const O=(be=m.parentElement)==null?void 0:be.getBoundingClientRect();if(!O)return;s==null&&t(3,s=m.id);const L=O.width/D,U=O.height/D,ot=C.clientX-(O.left+L/2),nt=C.clientY-(O.top+U/2);t(4,l=Math.floor(ot*100/L)),t(5,c=Math.floor(nt*100/U))};function g(m){if(s){let C=m.target;d(C,m)}}const k=()=>{if(s){const m=i.findSquare(U=>U.notation===s);if(!m.piece){t(3,s=null);return}const C=m,O=he(l,c,r),L=i.board[O.y][O.x];if(ce(C,L)){G(C,L);return}T({from:C,to:L})}t(3,s=null)},b=m=>{t(6,a=null),T(m.detail)},T=m=>{h("manualMoveMade",{...m})},G=(m,C)=>{t(6,a={from:m,to:C})},ce=(m,C)=>!i.getLegalMoves().some(L=>L.from.notation===m.notation&&L.to.notation===C.notation)||m.piece.type!==p.PAWN?!1:m.piece.color===u.WHITE&&C.y===_||m.piece.color===u.BLACK&&C.y===S,he=(m,C,O)=>{O===u.BLACK?m=Math.abs(700-m):C=Math.abs(700-C);const L=Math.max(S,Math.min(_,Math.round(m/100))),U=Math.max(S,Math.min(_,Math.round(C/100)));return{x:L,y:U}},tt=(m,C)=>C.attackTarget.notation===m.notation;return n.$$set=m=>{"boardSize"in m&&t(0,o=m.boardSize),"chessGame"in m&&t(1,i=m.chessGame),"playerColor"in m&&t(2,r=m.playerColor)},[o,i,r,s,l,c,a,f,g,k,b,tt]}class Kt extends oe{constructor(e){super(),te(this,e,Lt,Ot,x,{boardSize:0,chessGame:1,playerColor:2})}}function xe(n,e,t){const o=n.slice();return o[7]=e[t],o[9]=t,o}function Ht(n){let e,t,o,i=n[7].move.from.notation+" -> "+n[7].move.to.notation,r;return{c(){e=A("div"),o=H(),r=B(i),E(e,"class",t=W(n[7].move.from.piece.type+" history-logo "+n[7].move.from.piece.color.toLowerCase())+" svelte-wp4h0a")},m(s,l){w(s,e,l),w(s,o,l),w(s,r,l)},p(s,l){l&1&&t!==(t=W(s[7].move.from.piece.type+" history-logo "+s[7].move.from.piece.color.toLowerCase())+" svelte-wp4h0a")&&E(e,"class",t),l&1&&i!==(i=s[7].move.from.notation+" -> "+s[7].move.to.notation)&&Y(r,i)},d(s){s&&(I(e),I(o),I(r))}}}function Wt(n){let e="Start position",t;return{c(){t=B(e)},m(o,i){w(o,t,i)},p:R,d(o){o&&I(t)}}}function Ue(n){let e,t;function o(s,l){return s[7].move?Ht:Wt}let i=o(n),r=i(n);return{c(){e=A("li"),r.c(),t=H(),E(e,"class","history-entry svelte-wp4h0a"),M(e,"currentHistory",n[9]===n[1])},m(s,l){w(s,e,l),r.m(e,null),N(e,t)},p(s,l){i===(i=o(s))&&r?r.p(s,l):(r.d(1),r=i(s),r&&(r.c(),r.m(e,t))),l&2&&M(e,"currentHistory",s[9]===s[1])},d(s){s&&I(e),r.d()}}}function Gt(n){let e,t,o,i,r,s=P(n[0].history),l=[];for(let c=0;c<s.length;c+=1)l[c]=Ue(xe(n,s,c));return{c(){e=A("div"),t=A("div"),o=A("ol");for(let c=0;c<l.length;c+=1)l[c].c();E(o,"class","svelte-wp4h0a"),E(e,"class","box svelte-wp4h0a")},m(c,a){w(c,e,a),N(e,t),N(t,o);for(let h=0;h<l.length;h+=1)l[h]&&l[h].m(o,null);i||(r=se(window,"keydown",at(n[2])),i=!0)},p(c,[a]){if(a&3){s=P(c[0].history);let h;for(h=0;h<s.length;h+=1){const f=xe(c,s,h);l[h]?l[h].p(f,a):(l[h]=Ue(f),l[h].c(),l[h].m(o,null))}for(;h<l.length;h+=1)l[h].d(1);l.length=s.length}},i:R,o:R,d(c){c&&I(e),ee(l,c),i=!1,r()}}}function Bt(n,e,t){let{gameManager:o}=e,i=null;const r=ke(),s=()=>{r("historySelected",l())},l=()=>i==null?o.chessGame:i<o.history.length?o.history[i].game:o.chessGame,c=h=>{o.result&&(i==null?t(1,i=o.history.length-1):h===1?t(1,i=i<o.history.length-1?i+1:i):h===-1&&t(1,i=i>0?i-1:i),s())},a=h=>{switch(h.key){case"ArrowRight":case"ArrowDown":c(1);break;case"ArrowLeft":case"ArrowUp":c(-1);break}};return n.$$set=h=>{"gameManager"in h&&t(0,o=h.gameManager)},[o,i,a]}class Ft extends oe{constructor(e){super(),te(this,e,Bt,Gt,x,{gameManager:0})}}function Je(n){let e,t="Player turn = "+n[0].chessGame.playerTurn,o,i,r="Result = "+n[0].result,s,l,c="Moves = "+n[0].chessGame.fullmoveNumber,a,h,f,d,g,k,b;return d=new Kt({props:{chessGame:n[1],playerColor:n[2],boardSize:Ve}}),d.$on("manualMoveMade",n[3]),k=new Ft({props:{gameManager:n[0]}}),k.$on("historySelected",n[4]),{c(){e=A("div"),o=B(t),i=H(),s=B(r),l=H(),a=B(c),h=H(),f=A("div"),ae(d.$$.fragment),g=H(),ae(k.$$.fragment),E(f,"class","board-controls svelte-vw9cvi"),ne(f,"height",Ve+"px")},m(T,G){w(T,e,G),N(e,o),N(e,i),N(e,s),N(e,l),N(e,a),N(e,h),N(e,f),j(d,f,null),N(f,g),j(k,f,null),b=!0},p(T,G){(!b||G&1)&&t!==(t="Player turn = "+T[0].chessGame.playerTurn)&&Y(o,t),(!b||G&1)&&r!==(r="Result = "+T[0].result)&&Y(s,r),(!b||G&1)&&c!==(c="Moves = "+T[0].chessGame.fullmoveNumber)&&Y(a,c);const ce={};G&2&&(ce.chessGame=T[1]),d.$set(ce);const he={};G&1&&(he.gameManager=T[0]),k.$set(he)},i(T){b||(K(d.$$.fragment,T),K(k.$$.fragment,T),b=!0)},o(T){F(d.$$.fragment,T),F(k.$$.fragment,T),b=!1},d(T){T&&I(e),Z(d),Z(k)}}}function $t(n){let e=n[0].chessGame.playerTurn,t,o,i=Je(n);return{c(){i.c(),t=le()},m(r,s){i.m(r,s),w(r,t,s),o=!0},p(r,[s]){s&1&&x(e,e=r[0].chessGame.playerTurn)?(qe(),F(i,1,1,R),et(),i=Je(r),i.c(),K(i,1),i.m(t.parentNode,t)):i.p(r,s)},i(r){o||(K(i),o=!0)},o(r){F(i),o=!1},d(r){r&&I(t),i.d(r)}}}let Ve=800;function Dt(n,e,t){let{gameManager:o}=e,i=o.gameConfig.gameMode.playerColor,r=o.chessGame;const s=async f=>{o.makeMove(f),await l()},l=async()=>{t(1,r=o.chessGame),t(0,o),await ft()},c=f=>{a(f)},a=async f=>{const d=f.detail;o.gameConfig.gameMode.type!=="AiVsAi"&&r.playerTurn==d.from.piece.color&&(await s(d),o.checkAndHandleSinglePlayerMove().then(g=>l()))},h=f=>{t(1,r=f.detail)};return n.$$set=f=>{"gameManager"in f&&t(0,o=f.gameManager)},[o,r,i,c,h]}class xt extends oe{constructor(e){super(),te(this,e,Dt,$t,x,{gameManager:0})}}class Ut{constructor(e){v(this,"boardScorer");this.boardScorer=e}async getMove(e,t,o,i){const r=e.getLegalMoves();if(r.length===0)throw new Error("No legal moves present - the game should have ended!");const s=Math.floor(Math.random()*(r.length-1));return r[s]}}class Qe{getScore(e,t,o){return 0}}class Jt{constructor(e){v(this,"boardScorer");this.boardScorer=e}async getMove(e,t,o,i){const r=e.getLegalMoves();if(r.length===0)throw new Error("No legal moves present - the game should have ended!");return r[0]}}const{port1:Vt,port2:ye}=new MessageChannel;ye.start();function Qt(){return new Promise(n=>{const e=Math.random();ye.addEventListener("message",function t(o){o.data===e&&(ye.removeEventListener("message",t),n())}),Vt.postMessage(e)})}class zt{constructor(e){v(this,"boardScorer");v(this,"skips",{});v(this,"evaluatedPositions",0);this.boardScorer=e,this.evaluatedPositions=0}async getMove(e,t,o,i){this.evaluatedPositions=0;let r=Me,s=Ce;const l={chessGame:e.clone(),threefoldRepetitionStack:JSON.parse(JSON.stringify(t))},c=await this.minMax(l,i,r,s,l.chessGame.playerTurn!=e.playerTurn,i);return console.log("Evaluation complete! Alpha-Beta Pruning :",this.skips," Best found move:",c.move,"Total evaluated moves:"+this.evaluatedPositions),c.move}async minMax(e,t,o,i,r,s){if(await Qt(),t===0||e.chessGame.getLegalMoves().length===0)return this.evaluatedPositions++,this.evalGame(e,t===0?t+1:t);if(r){let l=Me,c=null;for(let[a,h]of e.chessGame.getLegalMoves().sort(we).entries()){const f=this.asNode(e,h),g=await this.minMax(f,t-1,o,i,!1,s),k=g.score??g;if(k>l?c=h:k==l&&(c=Math.floor(Math.random()*2)?c:h),l=Math.max(l,k),o=Math.max(o,l),i<=o){const b=e.chessGame.getLegalMoves().length-(a+1);this.addSkips(t-1,b);break}}return{score:l,move:c}}else{let l=Ce,c=null;for(let[a,h]of e.chessGame.getLegalMoves().sort(we).entries()){const f=this.asNode(e,h),g=await this.minMax(f,t-1,o,i,!0,s),k=g.score??g;if(k<l?c=h:k==l&&(c=Math.floor(Math.random()*2)?c:h),l=Math.min(l,k),i=Math.min(i,k),i<=o){const b=e.chessGame.getLegalMoves().length-(a+1);this.addSkips(t-1,b);break}}return{score:l,move:c}}}addSkips(e,t){if(!this.skips[e]){this.skips[e]=t;return}this.skips[e]+=t}evalGame(e,t){return this.boardScorer.getScore(e.chessGame,e.threefoldRepetitionStack,t)}asNode(e,t){const o=e.chessGame.clone();let i=JSON.parse(JSON.stringify(e.threefoldRepetitionStack));return o.makeMove(t),i=this.updateThreefoldRepetition(o,i),{chessGame:o,threefoldRepetitionStack:i}}moveToString(e){return e?"("+e.from.piece.type+") "+e.from.notation+" -> "+e.to.notation:""}updateThreefoldRepetition(e,t){let o={board:e.board,legalMoves:e.getLegalMoves()};const i=t.findIndex(r=>{const s=r.position.board.flat().every(c=>e.squareExists(a=>{var h,f,d,g;return a.notation===c.notation&&((h=a.piece)==null?void 0:h.color)===((f=c.piece)==null?void 0:f.color)&&((d=a.piece)==null?void 0:d.type)===((g=c.piece)==null?void 0:g.type)})),l=r.position.legalMoves.length===o.legalMoves.length&&r.position.legalMoves.every(c=>o.legalMoves.some(a=>{var h,f,d,g;return a.from.notation===c.from.notation&&a.to.notation===c.to.notation&&a.promotion===c.promotion&&((h=a.from.piece)==null?void 0:h.type)===((f=c.from.piece)==null?void 0:f.type)&&((d=a.from.piece)==null?void 0:d.color)===((g=c.from.piece)==null?void 0:g.color)}));return s&&l});return i>=0?t[i].timesReached++:t.push({position:o,timesReached:1}),t}}class Yt{constructor(){v(this,"getChainScore",(e,t)=>[{color:u.WHITE,x:e.x+1,y:e.y+1},{color:u.WHITE,x:e.x-1,y:e.y+1},{color:u.BLACK,x:e.x-1,y:e.y-1},{color:u.BLACK,x:e.x+1,y:e.y-1}].filter(i=>{var r,s;return e.piece.color===i.color&&this.coordinateInsideBoard({x:i.x,y:i.y})&&((r=t[i.y][i.x].piece)==null?void 0:r.color)===e.piece.color&&((s=t[i.y][i.x].piece)==null?void 0:s.type)===p.PAWN}).map(i=>e.piece.color===u.WHITE?Te:Te*-1))}getScore(e,t,o){if(e.getLegalMoves().length===0)return e.kingInCheck(u.WHITE)?kt-o:e.kingInCheck(u.BLACK)?_t+o:0;if(t.some(a=>a.timesReached>=3))return 0;const i=e.board.flat(),r=i.map(a=>a.piece?yt(a.piece):0).reduce((a,h)=>a+h,0),s=i.map(a=>a.piece&&a.piece.type===p.PAWN?this.getChainScore(a,e.board):0).flat().reduce((a,h)=>a+h,0),l=i.filter(a=>{var h;return((h=a.piece)==null?void 0:h.type)===p.PAWN}).map(a=>{var h;return((h=a.piece)==null?void 0:h.color)===u.WHITE?(a.y-2)*Ie:(_-(a.y+2))*Ie*-1}).reduce((a,h)=>a+h,0),c=i.map(a=>e.getAttacksForPiece(a)).flat().map(a=>{let h=Et;return a.attackTarget.piece!=null&&(h+=a.attackTarget.piece.color===a.attacker.piece.color?Mt:St*de(a.attackTarget.piece),a.attackTarget.piece.color!==a.attacker.piece.color&&a.attackTarget.piece.type===p.KING&&(h+=Ct)),h+=["d5","d4","e5","e4"].filter(f=>a.attackTarget.notation===f).length*bt,h+=["c5","c4","f5","f4"].filter(f=>a.attackTarget.notation===f).length*vt,a.attacker.piece.color===u.BLACK?h*-1:h}).reduce((a,h)=>a+h,0);return r+s+l+c}coordinateInsideBoard(e){return e.x>=S&&e.x<=_&&e.y>=S&&e.y<=_}}function Xt(n){let e,t,o;return t=new xt({props:{gameManager:n[0]}}),{c(){e=A("main"),ae(t.$$.fragment)},m(i,r){w(i,e,r),j(t,e,null),o=!0},p:R,i(i){o||(K(t.$$.fragment,i),o=!0)},o(i){F(t.$$.fragment,i),o=!1},d(i){i&&I(e),Z(t)}}}function jt(n){let e={gameMode:{type:"SinglePlayerVsAi",playerColor:u.WHITE,algorithmOption:{motor:new zt(new Yt),depth:3},timeFormat:{white:{secondsIncrement:0,secondsStartTime:300},black:{secondsIncrement:0,secondsStartTime:600}}},FEN:null};return u.WHITE,new Ut(new Qe),new Jt(new Qe),[new Tt(e)]}class Zt extends oe{constructor(e){super(),te(this,e,jt,Xt,x,{})}}new Zt({target:document.getElementById("app")});
